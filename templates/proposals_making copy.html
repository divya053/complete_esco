<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposals Making</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- PDF.js for viewing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- PDF-lib for editing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        /* Custom scrollbar for sidebars - thin and subtle */
        aside ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        aside ::-webkit-scrollbar-track {
            background: transparent;
        }

        aside ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.3);
            border-radius: 3px;
            transition: background 0.2s;
        }

        aside ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.5);
        }

        /* Firefox scrollbar for sidebars */
        aside {
            scrollbar-width: thin;
            scrollbar-color: rgba(156, 163, 175, 0.3) transparent;
        }

        /* Invisible scrollbar for main content area only */
        main {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        main::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
            background: transparent;
        }

        main::-webkit-scrollbar-track {
            display: none;
        }

        main::-webkit-scrollbar-thumb {
            display: none;
        }

        .dropdown-item:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .dropdown-item:disabled:hover {
            background-color: transparent;
        }

        /* Smooth transitions */
        * {
            transition-property: color, background-color, border-color, opacity, transform;
            transition-duration: 0.2s;
            transition-timing-function: ease-in-out;
        }

        /* Card hover effects */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* Button animations */
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.2), 0 2px 4px -1px rgba(5, 150, 105, 0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            box-shadow: 0 6px 8px -1px rgba(5, 150, 105, 0.3), 0 4px 6px -1px rgba(5, 150, 105, 0.2);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            box-shadow: 0 4px 6px -1px rgba(124, 58, 237, 0.2), 0 2px 4px -1px rgba(124, 58, 237, 0.1);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #5b21b6 100%);
            box-shadow: 0 6px 8px -1px rgba(124, 58, 237, 0.3), 0 4px 6px -1px rgba(124, 58, 237, 0.2);
            transform: translateY(-1px);
        }

        .btn-accent {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            box-shadow: 0 4px 6px -1px rgba(8, 145, 178, 0.2), 0 2px 4px -1px rgba(8, 145, 178, 0.1);
        }

        .btn-accent:hover {
            background: linear-gradient(135deg, #0e7490 0%, #155e75 100%);
            box-shadow: 0 6px 8px -1px rgba(8, 145, 178, 0.3), 0 4px 6px -1px rgba(8, 145, 178, 0.2);
            transform: translateY(-1px);
        }

        /* Section active state */
        .section-active {
            background: linear-gradient(90deg, rgba(5, 150, 105, 0.08) 0%, rgba(5, 150, 105, 0.03) 100%);
            border-left: 4px solid #059669;
        }

        /* Glass morphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Table styling for Corporate Qualifications section */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.875rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .prose table thead {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .prose table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #d1d5db;
            font-size: 0.875rem;
        }

        .prose table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .prose table tbody tr:hover {
            background-color: #f9fafb;
        }

        .prose table tbody tr:last-child td {
            border-bottom: none;
        }

        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .prose h3:first-child {
            margin-top: 0;
        }

        .prose p {
            margin-bottom: 1rem;
            line-height: 1.75;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-50 via-gray-100 to-gray-50 text-gray-800 h-screen overflow-hidden">
    <div class="flex h-full overflow-hidden">
        <!-- Section navigator - Fixed Left Sidebar -->
        <aside class="hidden lg:flex lg:w-80.2 bg-white border-r border-gray-200 flex-col shadow-sm h-full">
            <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h1 class="text-lg font-semibold text-gray-900">Add new section</h1>
                    <button id="addSectionBtn"
                        class="inline-flex items-center justify-center h-9 w-9 rounded-full bg-emerald-50 text-emerald-600 hover:bg-emerald-100 transition-all hover:scale-110 shadow-sm">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <!-- Compliance Blueprint & Draft Builder Section -->
            <section id="rfpDeepAnalysisSection"
                class="mx-4 mt-4 mb-4 bg-white rounded-sm border border-gray-200 shadow-md card-hover overflow-hidden flex-shrink-0">
                <div class="px-4 py-4 border-b border-gray-100 bg-gradient-to-r from-white to-gray-50">
                    <div class="mb-3">
                        <h3 class="text-base font-semibold text-gray-900 mb-1">Compliance Blueprint & Draft Builder</h3>
                        <!-- <p class="text-xs text-gray-500">Run a full compliance analysis and receive a proposal-ready outline, boilerplate drafts, templates, and submission checklist tailored to this RFP.</p> -->
                    </div>
                    <button id="runDeepAnalysisBtn"
                        class="w-full btn-secondary inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white disabled:opacity-60 disabled:cursor-not-allowed">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>Analyze RFP</span>
                    </button>
                </div>
                <div class="px-4 py-4 space-y-3">
                    <div id="deepAnalysisStatus"
                        class="hidden rounded-lg border border-cyan-200 bg-cyan-50 px-3 py-2 text-xs text-cyan-700 flex items-center gap-2">
                        <div class="h-3 w-3 border-2 border-cyan-200 border-t-cyan-600 rounded-full animate-spin"></div>
                        <span>Analyzing RFP documents. This may take a moment…</span>
                    </div>
                    <div id="deepAnalysisError" class="hidden rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-600"></div>
                    <div id="deepAnalysisOutput"
                        class="prose prose-emerald max-w-none text-gray-800 leading-relaxed space-y-3 text-xs"></div>
                </div>
            </section>
            
            <div class="flex-1 overflow-y-auto">
                <ul id="sectionList" class="divide-y divide-gray-100">
                    <!-- populated via JS -->
                </ul>
            </div>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden">
            <div class="flex flex-1 overflow-hidden h-full">
                {% set viewer_bid_id = bid_context.g_id if bid_context and bid_context.g_id else None %}
                {% if not viewer_bid_id %}
                {% set viewer_bid_id = bid_context.bid_id if bid_context and bid_context.bid_id else (bid_id if
                bid_id
                else None) %}
                {% endif %}
                <main class="flex-1 overflow-y-auto px-6 lg:px-10 py-8 space-y-8 h-full">
                    <!-- RFP Name Header -->
                    {% if bid_context and bid_context.rfp_label %}
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <i class="fas fa-file-pdf text-emerald-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-0.5">RFP Document</p>
                                <h2 class="text-lg font-semibold text-gray-900 truncate">{{ bid_context.rfp_label }}</h2>
                            </div>
                        </div>
                    </div>
                    {% elif bid_context and bid_context.project_name %}
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <i class="fas fa-file-pdf text-emerald-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-0.5">RFP Document</p>
                                <h2 class="text-lg font-semibold text-gray-900 truncate">{{ bid_context.project_name }}</h2>
                            </div>
                        </div>
                    </div>
                    {% elif bid_name %}
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <i class="fas fa-file-pdf text-emerald-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-0.5">RFP Document</p>
                                <h2 class="text-lg font-semibold text-gray-900 truncate">{{ bid_name }}</h2>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Requirements and Attachments Section (Hidden by default, shown when selected) -->
                    <section id="requirementsAttachmentsSection"
                        class="hidden bg-white rounded-2xl border border-gray-200 shadow-lg card-hover">
                        <div class="px-6 py-5 border-b border-gray-100">
                            <h3 class="text-2xl font-semibold text-gray-900 leading-tight mb-2">Requirements and
                                Attachments</h3>
                            <p class="text-sm text-gray-600 leading-relaxed">Review the requirements and required
                                attachments extracted from the RFP document. Upload your documents to fulfill the
                                attachment requirements.</p>
                        </div>
                        <div class="px-6 py-6 space-y-6">
                            <!-- Analyze Requirements Button -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-semibold uppercase tracking-wide text-gray-500 mb-1">
                                        RFP REQUIREMENTS & ATTACHMENTS</h4>
                                    <p class="text-xs text-gray-500">Click to analyze the RFP and extract all
                                        requirements and required attachments.</p>
                                </div>
                                <button id="analyzeRequirementsBtn"
                                    class="btn-accent inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none">
                                    <i class="fas fa-search"></i>
                                    Analyze RFP
                                </button>
                            </div>

                            <!-- Loading State -->
                            <div id="requirementsAnalyzing"
                                class="hidden flex items-center gap-2 text-sm text-cyan-600">
                                <div
                                    class="h-4 w-4 border-2 border-cyan-200 border-t-cyan-600 rounded-full animate-spin">
                                </div>
                                <span>Analyzing RFP document for requirements and attachments...</span>
                            </div>

                            <!-- Requirements Display -->
                            <div id="requirementsDisplay"
                                class="hidden rounded-xl border border-cyan-100 bg-cyan-50/60 px-4 py-4 text-sm text-gray-700 space-y-4">
                                <div class="flex items-center justify-between gap-3">
                                    <h5 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">
                                        EXTRACTED REQUIREMENTS & ATTACHMENTS</h5>
                                    <span class="text-xs text-gray-400">From RFP analysis</span>
                                </div>
                                <div id="requirementsItemsList" class="space-y-3 mt-4">
                                    <!-- Individual requirement items will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Section metadata -->
                    <section id="regularSectionDisplay"
                        class="bg-white rounded-2xl border border-gray-200 shadow-lg card-hover overflow-hidden">
                        <div
                            class="border-b border-gray-100 px-6 py-5 flex items-start justify-between bg-gradient-to-r from-white to-gray-50">
                            <div>
                                <div
                                    class="mb-1 inline-flex items-center gap-1 rounded-full bg-emerald-50 px-3 py-1 text-sm font-medium text-emerald-700">
                                    <span id="sectionStatus">Saved</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <h3 id="sectionTitleDisplay"
                                        class="text-2xl font-semibold text-gray-900 leading-tight"></h3>
                                    <button id="renameSectionBtn"
                                        class="text-sm text-emerald-600 hover:text-emerald-700 font-medium transition-colors">Rename</button>
                                </div>
                            </div>
                            <button
                                class="hidden md:inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-500 hover:border-gray-300">
                                <i class="fas fa-chart-line"></i>
                                <span>Evaluate</span>
                            </button>
                        </div>

                        <div class="px-6 py-6 space-y-8">
                            <div>
                                <h4 class="text-sm font-semibold uppercase tracking-wide text-gray-500 mb-3">
                                    ANALYZING GUIDELINES</h4>
                                <div class="rounded-xl border border-dashed border-cyan-200 bg-cyan-50/60 px-4 py-4 text-sm text-cyan-800 leading-relaxed"
                                    id="sectionGuidanceDisplay"></div>
                            </div>

                            <div class="space-y-4">
                                <div class="flex flex-wrap items-center gap-3">
                                    <button id="reviewGenerateBtn"
                                        class="btn-secondary inline-flex items-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold text-white">
                                        <i class="fas fa-bolt"></i>
                                        Generate
                                    </button>
                                    <button id="quickSaveBtn"
                                        class="btn-primary inline-flex items-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-save"></i>
                                        Save
                                    </button>
                                    <button id="writeManuallyBtn"
                                        class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-semibold text-gray-700 hover:bg-gray-50">
                                        <i class="fas fa-pen"></i>
                                        Write Manually
                                    </button>
                                    <!-- <p class="text-xs text-gray-500">The AI builder stitches the narrative based on your RFP and company profile.</p> -->
                                </div>
                                <!-- <div class="rounded-2xl border border-cyan-100 bg-white px-4 py-4 shadow-sm space-y-3">
                                    <div class="flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
                                        <div>
                                            <p class="text-sm font-semibold uppercase tracking-wide text-gray-600">
                                                AI REQUIREMENTS OUTLINE</p>
                                            <p class="text-xs text-gray-500">Extracts mandatory requirements for this
                                                section by reading the linked RFP document.</p>
                                        </div>
                                        <button id="outlineAnalyzeBtn"
                                            class="btn-accent inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none">
                                            <i class="fas fa-robot"></i>
                                            Analyze with AI
                                        </button>
                                    </div>
                                    <div id="outlineAnalyzing"
                                        class="hidden flex items-center gap-2 text-sm text-cyan-600">
                                        <div
                                            class="h-4 w-4 border-2 border-cyan-200 border-t-cyan-600 rounded-full animate-spin">
                                        </div>
                                        <span>Reviewing RFP content for section requirements…</span>
                                    </div>
                                    <div id="outlineResultContainer"
                                        class="hidden rounded-xl border border-cyan-100 bg-cyan-50/60 px-4 py-3 text-sm text-gray-700 space-y-3">
                                        <div class="flex items-center justify-between gap-3">
                                            <h5 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">
                                                AI
                                                Output</h5>
                                            <span class="text-xs text-gray-400">Formatted for direct proposal
                                                use</span>
                                        </div>
                                        <div id="outlineContent"
                                            class="whitespace-pre-wrap text-sm leading-relaxed text-gray-700"></div>
                                    </div>
                                </div> -->
                                <div id="subCategoryContentDisplay"
                                    class="hidden mb-4 prose prose-cyan max-w-none text-gray-700 leading-relaxed space-y-3 p-4 bg-cyan-50 rounded-lg border border-cyan-200">
                                    <h5 class="text-lg font-semibold text-gray-900 mb-2" id="subCategoryTitleDisplay">
                                    </h5>
                                    <div id="subCategoryContentText" class="text-gray-700"></div>
                                </div>
                                <div id="sectionContentDisplay"
                                    class="prose prose-blue max-w-none text-gray-700 leading-relaxed space-y-3">
                                </div>
                                <textarea id="sectionContentEditor"
                                    class="hidden w-full rounded-xl border border-gray-300 px-4 py-3 text-sm leading-relaxed focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                    rows="12"></textarea>
                                <div id="editorActions" class="hidden flex justify-end gap-3 mt-3">
                                    <button id="cancelEditBtn"
                                        class="px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">Cancel</button>
                                    <button id="saveSectionBtn"
                                        class="btn-primary px-4 py-2 rounded-lg text-sm font-semibold text-white">Save
                                        section</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="rfpPreviewSection"
                        class="bg-white rounded-2xl border border-gray-200 shadow-lg card-hover overflow-hidden"
                        data-bid-id="{{ viewer_bid_id or '' }}"
                        data-api="{{ url_for('api_rfp_file_parsed', g_id=viewer_bid_id) if viewer_bid_id else '' }}"
                        data-view-url="{{ url_for('view_rfp_file_by_g', g_id=viewer_bid_id) if viewer_bid_id else '' }}">
                        <div
                            class="px-6 py-5 border-b border-gray-100 flex items-center justify-between bg-gradient-to-r from-white to-gray-50">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">RFP Source Document</h3>
                                <!-- <p class="text-sm text-gray-500 mt-1">RFP files are automatically loaded from the
                                    database. Preview the latest RFP attachment and review extracted text snippets.
                                </p> -->
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="file" id="rfpUploadInput" class="hidden" accept=".pdf">
                                <button id="rfpUploadBtn"
                                    class="btn-secondary inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-white {{ '' if viewer_bid_id else 'hidden' }}"
                                    title="Upload additional RFP PDF (files from database are already loaded)">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Upload PDF
                                </button>
                                <button id="rfpReloadBtn"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300 {{ '' if viewer_bid_id else 'hidden' }}">
                                    <i class="fas fa-rotate-right"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="px-6 py-6 grid gap-6 lg:grid-cols-1">
                            <div class="flex flex-col gap-3">
                                {% if viewer_bid_id %}
                                <!-- PDF Editor Controls -->
                                <div id="pdfEditorControls" class="flex items-center justify-between gap-2 mb-2 hidden">
                                    <div class="flex items-center gap-2">
                                        <button id="pdfPrevPage" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            <i class="fas fa-chevron-left"></i> Previous
                                        </button>
                                        <span id="pdfPageInfo" class="px-3 py-1.5 text-sm text-gray-700">Page 1 of 1</span>
                                        <button id="pdfNextPage" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            Next <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <input type="number" id="pdfPageInput" min="1" value="1" 
                                            class="w-16 px-2 py-1.5 text-sm border border-gray-300 rounded-lg text-center">
                                        <button id="pdfGoToPage" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            Go
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="pdfZoomOut" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <span id="pdfZoomLevel" class="px-2 text-sm text-gray-700">100%</span>
                                        <button id="pdfZoomIn" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button id="pdfAddText" class="px-3 py-1.5 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700">
                                            <i class="fas fa-font"></i> Add Text
                                        </button>
                                        <button id="pdfExport" class="px-3 py-1.5 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700">
                                            <i class="fas fa-download"></i> Export PDF
                                        </button>
                                    </div>
                                </div>
                                <!-- PDF Canvas Viewer -->
                                <div id="pdfViewerContainer" class="w-full rounded-xl border border-gray-200 bg-gray-50 shadow-inner overflow-auto" style="height: 520px;">
                                    <canvas id="pdfCanvas" class="mx-auto"></canvas>
                                    <div id="pdfLoadingIndicator" class="flex items-center justify-center h-full">
                                        <div class="text-center">
                                            <div class="h-8 w-8 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mx-auto mb-2"></div>
                                            <p class="text-sm text-gray-500">Loading PDF...</p>
                                        </div>
                                    </div>
                                    <div id="pdfErrorIndicator" class="hidden flex items-center justify-center h-full">
                                        <div class="text-center">
                                            <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                                            <p class="text-sm text-gray-500">PDF preview unavailable. Attempting to decrypt...</p>
                                        </div>
                                    </div>
                                </div>
                                <p id="rfpPreviewFallback" class="hidden text-sm text-gray-500">The RFP preview is
                                    currently unavailable.</p>
                                {% else %}
                                <div
                                    class="flex items-center justify-center w-full h-[220px] rounded-xl border border-dashed border-gray-200 bg-gray-50 text-sm text-gray-500">
                                    Select or attach a bid to preview its RFP.
                                </div>
                                {% endif %}
                            </div>
                            <!-- <div class="flex flex-col gap-3">
                                <div id="rfpParseStatus" class="text-xs text-gray-500 hidden"></div>
                                <div id="rfpTextContainer" class="min-h-[200px] max-h-[520px] overflow-y-auto rounded-xl border border-gray-200 bg-white p-4 shadow-inner text-sm leading-relaxed space-y-4">
                                    {% if not viewer_bid_id %}
                                    <p class="text-sm text-gray-500">Attach an RFP PDF to view its extracted content.</p>
                                    {% endif %}
                                </div>
                                <button id="rfpLoadMoreBtn"
                                        class="hidden self-start inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300">
                                    <i class="fas fa-layer-group"></i>
                                    Load more pages
                                </button>
                            </div>
                        </div> -->
                    </section>

                    <!-- Processing status -->
                    <section id="processingStatus"
                        class="hidden bg-white rounded-2xl border border-cyan-100 px-6 py-6 shadow-sm">
                        <div class="flex items-start gap-4">
                            <div class="mt-1">
                                <div
                                    class="h-6 w-6 border-2 border-cyan-200 border-t-cyan-600 rounded-full animate-spin">
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-cyan-800">Generating proposal package</h4>
                                <!-- <p class="text-sm text-cyan-700 mt-1">We are assembling all required sections and attachments. This typically takes less than a minute for standard RFPs.</p> -->
                                <div id="statusContent" class="mt-4 grid gap-3 text-sm text-cyan-800"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Generated proposals -->
                    <section class="bg-white rounded-2xl border border-gray-200 shadow-lg card-hover overflow-hidden">
                        <div
                            class="px-6 py-5 flex items-center justify-between border-b border-gray-100 bg-gradient-to-r from-white to-gray-50">
                            <h3 class="text-xl font-semibold text-gray-900">Generated Proposals</h3>
                            <div class="flex items-center gap-2">
                                <button onclick="refreshProposals()"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh
                                </button>
                                <button id="generateProposalBtn"
                                    class="btn-primary inline-flex items-center gap-1 rounded px-3 py-2 text-sm text-white font-medium transition-all">
                                    <i class="fas fa-wand-magic-sparkles text-[9px]"></i>
                                    <span>Generate Proposal</span>
                                </button>
                            </div>
                        </div>
                        <div id="proposalsList" class="px-6 py-6 space-y-4">
                            {% if proposals %}
                            {% for proposal in proposals %}
                            <article
                                class="rounded-xl border border-gray-200 px-4 py-4 hover:border-emerald-200 hover:shadow-sm transition card-hover">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">{{ proposal.name }}</h4>
                                        <dl class="mt-2 flex flex-wrap gap-x-6 gap-y-1 text-sm text-gray-600">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-file-pdf text-red-500"></i>
                                                <dt class="font-medium text-gray-700">RFP:</dt>
                                                <dd>{{ proposal.rfp_name }}</dd>
                                            </div>
                                            {% if proposal.company %}
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-building text-gray-400"></i>
                                                <dt class="font-medium text-gray-700">Company:</dt>
                                                <dd>{{ proposal.company }}</dd>
                                            </div>
                                            {% endif %}
                                            {% if proposal.bid_name %}
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-tag text-gray-400"></i>
                                                <dt class="font-medium text-gray-700">Bid:</dt>
                                                <dd>{{ proposal.bid_name }}{% if proposal.bid_id %} · ID {{
                                                    proposal.bid_id }}{% endif %}</dd>
                                            </div>
                                            {% endif %}
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-clock text-gray-400"></i>
                                                <dt class="font-medium text-gray-700">Generated:</dt>
                                                <dd>{{ proposal.created_at }}</dd>
                                            </div>
                                        </dl>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <a href="{{ proposal.download_url }}"
                                            class="btn-primary inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white">
                                            <i class="fas fa-download"></i>
                                            Download
                                        </a>
                                    </div>
                                </div>
                            </article>
                            {% endfor %}
                            {% else %}
                            <p class="text-center text-gray-500">No proposals generated yet. Attach your RFP and
                                click
                                Generate Proposal to get started.</p>
                            {% endif %}
                        </div>
                    </section>

                    <!-- Final proposal preview -->
                    <section id="finalProposalPreviewSection"
                        class="hidden bg-white rounded-2xl border border-gray-200 shadow-lg card-hover overflow-hidden">
                        <div
                            class="px-6 py-5 flex flex-col gap-3 md:flex-row md:items-center md:justify-between border-b border-gray-100 bg-gradient-to-r from-white to-gray-50">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Final Proposal Draft</h3>
                                <p class="text-sm text-gray-500" id="finalProposalStatus">Review the compiled proposal
                                    before downloading.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="finalProposalEditBtn"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit Preview</span>
                                </button>
                                <button id="finalProposalDownloadBtn"
                                    class="btn-primary inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-download"></i>
                                    <span>Download DOCX</span>
                                </button>
                            </div>
                        </div>
                        <div class="px-6 py-6">
                            <div
                                class="prose prose-blue max-w-none text-gray-800 leading-relaxed space-y-4 border border-dashed border-gray-200 rounded-2xl p-6 bg-gray-50"
                                id="finalProposalContent">
                                <p class="text-gray-500 text-sm">Your compiled proposal will appear here once generated.
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- Proposal settings -->
                    <section class="bg-white rounded-2xl border border-gray-200 shadow-lg card-hover overflow-hidden">
                        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-white to-gray-50">
                            <h3 class="text-xl font-semibold text-gray-900">Proposal settings</h3>
                        </div>
                        <div class="px-6 py-6">
                            <form id="uploadForm" action="{{ url_for('proposals_making') }}" method="POST"
                                enctype="multipart/form-data" class="space-y-4">
                                {% set linked_bid_id = viewer_bid_id if viewer_bid_id else (bid_id if bid_id else None)
                                %}
                                {% if linked_bid_id %}
                                <input type="hidden" name="bid_id" value="{{ linked_bid_id }}">
                                <input type="hidden" name="g_id" value="{{ linked_bid_id }}">
                                {% endif %}
                                {% if bid_name %}
                                <input type="hidden" name="bid_name" value="{{ bid_name }}">
                                {% endif %}
                                <div>
                                    <label for="rfpFolder" class="text-sm font-medium text-gray-700 mb-2 block">Attach RFP PDFs</label>
                                    {% if rfp_files and rfp_files|length > 0 %}
                                    <div class="mb-3 space-y-2">
                                        <p class="text-xs text-gray-600 font-medium">RFP files from database:</p>
                                        {% for rfp_file in rfp_files %}
                                        <div
                                            class="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm">
                                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                                <i class="fas fa-file-pdf text-red-500"></i>
                                                <span class="truncate">{{ rfp_file.filename }}</span>
                                            </div>
                                            <a href="{{ rfp_file.view_url }}" target="_blank"
                                                class="text-emerald-600 hover:text-emerald-700 text-xs transition-colors"
                                                title="View PDF">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <p class="text-xs text-gray-500 mb-2">Or upload additional PDFs:</p>
                                    {% endif %}
                                    <label
                                        class="flex flex-col items-center justify-center gap-2 rounded-xl border border-dashed border-gray-300 bg-gray-50 px-4 py-6 text-center text-sm text-gray-500 hover:border-emerald-300 hover:bg-emerald-50 transition-all cursor-pointer card-hover">
                                        <i class="fas fa-cloud-upload-alt text-2xl text-emerald-500"></i>
                                        <span id="rfpUploadLabel">Drop or browse PDFs</span>
                                        <input type="file" id="rfpFolder" name="rfp_files" accept=".pdf" multiple
                                            class="hidden">
                                    </label>
                                    <p class="text-xs text-gray-400 mt-2">AI will segment the RFP automatically and map it to the section list.</p>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="company" class="text-sm font-medium text-gray-700 mb-2 block">Select Company</label>
                                        <select name="company" id="company" required
                                            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all">
                                            <option value="">-- Select Company --</option>
                                            <option value="IKIO" {% if company=='IKIO' %}selected{% endif %}>IKIO</option>
                                            <option value="METCO" {% if company=='METCO' %}selected{% endif %}>METCO</option>
                                            <option value="SUNSPRINT" {% if company=='SUNSPRINT' %}selected{% endif %}>SUNSPRINT</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label for="proposalTemplate" class="text-sm font-medium text-gray-700 mb-2 block">Proposal Template</label>
                                        <select name="template" id="proposalTemplate" required
                                            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all">
                                            <option value="standard">Standard Proposal Template</option>
                                            <option value="technical">Technical Proposal Template</option>
                                            <option value="commercial">Commercial Proposal Template</option>
                                        </select>
                                    </div>
                                </div>

                                <button type="submit" class="hidden" id="generateSubmitHelper"></button>
                            </form>
                        </div>
                    </section>
                </main>

            <!-- AI helper / settings - Fixed Right Sidebar -->
            <aside
                class="hidden xl:block w-96 border-l border-gray-200 bg-white shadow-sm h-full flex flex-col overflow-hidden scrollbar">
                <div class="px-6 py-6 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-900">AI Agent</h3>
                    <!-- <p class="text-sm text-gray-500 mt-1"></p> -->
                </div>
                <div class="flex-1 overflow-y-auto">
                    <div class="px-6 py-6 space-y-5">


                        <div
                            class="rounded-2xl border border-gray-200 bg-white shadow-sm card-hover flex flex-col h-[800px]">
                            <div class="flex items-center gap-3 px-5 py-4 border-b border-gray-200 flex-shrink-0">
                                <span
                                    class="h-10 w-10 inline-flex items-center justify-center rounded-xl bg-slate-100 text-slate-500 text-lg">
                                    <i class="fas fa-pencil-alt"></i>
                                </span>
                                <div>
                                    <p class="font-semibold text-gray-900">Ask Questions related to the RFP</p>
                                    <!-- <p class="text-sm text-gray-500">Type your query below and get a quick AI
                                        response.
                                    </p> -->
                                </div>
                            </div>

                            <!-- Chat Messages Container -->
                            <div id="generalQueryResponse" class="flex-1 overflow-y-auto px-4 py-4 space-y-4 bg-gray-50"
                                style="scrollbar-width: none; -ms-overflow-style: none;">
                                <!-- Messages will be rendered here -->
                            </div>
                            <style>
                                #generalQueryResponse::-webkit-scrollbar {
                                    display: none;
                                }
                            </style>

                            <!-- Input Area at Bottom -->
                            <div class="border-t border-gray-200 bg-white px-4 py-4 flex-shrink-0">
                                <form id="generalQueryForm" class="flex items-end gap-2">
                                    <div class="flex w-full">
                                        <textarea id="generalQueryInput" name="general_query" rows="1"
                                            placeholder="Enter your question..."
                                            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 resize-none transition-all max-h-32 overflow-y-auto"
                                            style="min-height: 40px;"></textarea>
                                    </div>
                                    <button type="submit"
                                        class="btn-accent inline-flex items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm font-semibold text-white h-10 flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-paper-plane"></i>
                                        <span class="hidden sm:inline">Send</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    </div>
    </div>

    <script id="proposal-context-data" type="application/json">
        {{ {
            'sections': sections_outline,
            'bid': bid_context,
            'company': company or '',
            'contactEmail': contact_email or ''
        } | tojson | safe }}
    </script>

    <script>
        const proposalContextElement = document.getElementById('proposal-context-data');
        const proposalContext = proposalContextElement ? JSON.parse(proposalContextElement.textContent || '{}') : {};
        window.__proposalContext = proposalContext;

        const fallbackSections = [
            {
                id: 'section-1',
                title: 'Letter of Transmittal ',
                status: 'Saved',
                guidance: 'Summarize the company name, point of contact, DUNS, CAGE, and address exactly as stated in SAM.gov. Include the solicitation number and clearly mark the proposal volume.',
                content: [
                    'Apex Federal Solutions is pleased to submit this proposal for the Q-1075 SOF Operations Building Addition and Renovation at NAS Oceana Dam Neck Annex. We provide turnkey design-build services with proven performance on complex Department of Defense facility upgrades.',
                    'Primary Point of Contact: Jordan Blake, Program Director · (757) 555-1390 · proposals@apexfederal.com · 614 Patriot Way, Suite 200, Virginia Beach, VA 23451.',
                    'Secondary Contracting Contact: Lydia Chen, Director of Capture · (757) 555-2244 · contracts@apexfederal.com.',
                    'SAM UEI: X1Y2Z3A4B5C6 · CAGE Code: 4YV27. All representations and certifications are current in SAM as of November 2025.'
                ]
            },
            {
                id: 'section-2',
                title: '',
                status: 'In Progress',
                guidance: 'Add guidance for this new section.',
                content: [
                    'Use this placeholder section to capture unique narrative requirements called out in the solicitation. Drag and drop to reposition it where it makes the most sense in your proposal flow.'
                ]
            },
            {
                id: 'section-3',
                title: 'Acknowledgment of Amendments',
                status: 'Pending',
                guidance: 'List and acknowledge all solicitation amendments issued prior to proposal submission. Include amendment numbers and dates. If no amendments were issued, state “No amendments issued.”',
                content: [
                    'The offer or acknowledges receipt of Amendment 0001 dated 15 October 2025 and Amendment 0002 dated 22 October 2025. Each amendment has been incorporated into the technical approach, updated drawings, and pricing schedules.',
                    'No additional amendments were released. The offer or understands that failure to acknowledge future amendments may render the proposal non-responsive.'
                ]
            },
            {
                id: 'section-4',
                title: 'New Section',
                status: 'Draft',
                guidance: 'Add guidance for this new section.',
                content: []
            },
            {
                id: 'section-5',
                title: 'New Section',
                status: 'Draft',
                guidance: 'Add guidance for this new section.',
                content: []
            },
            {
                id: 'section-6',
                title: 'Price Proposal Form (Attachment A)',
                status: 'Saved',
                guidance: 'Ensure the pricing form mirrors the Government-provided Attachment A spreadsheet. Cross-check CLIN numbers, extended amounts, and totals.',
                content: [
                    'Attachment A – Price Proposal Form has been completed using the Government-furnished Excel workbook. The pricing reflects firm-fixed-price CLINs 0001 through 0004 and optional CLIN 0005.',
                    'Labor categories follow the Davis-Bacon wage determinations included in the RFP. Equipment and material estimates rely on current vendor quotes validated within the last 30 days.',
                    'A fully burdened cost summary and narrative assumptions are provided within Volume II for Contracting Officer review.'
                ]
            },
            {
                id: 'section-7',
                title: 'Bid Guarantee',
                status: 'Pending',
                guidance: 'Attach the bid bond or proof of surety. Confirm the surety is listed in Treasury Circular 570 and the amount meets the solicitation requirement.',
                content: [
                    'A bid bond in the amount of 20% of the total evaluated price is included. The bond is executed by Atlantic Surety Company (NAIC #12345), an approved corporate surety per Treasury Circular 570.',
                    'The original hard-copy bond with raised seal will be delivered to the Contracting Officer within one business day of electronic submission if requested.'
                ]
            },
            {
                id: 'section-8',
                title: 'Representations and Certifications',
                status: 'Saved',
                guidance: 'Confirm FAR 52.212-3 or 52.219-1 reps and certs are current. Include any additional provisions the contracting officer requested to be returned with the offer.',
                content: [
                    'Updated FAR and DFARS representations and certifications are incorporated by reference through the offer or’s active SAM registration.',
                    'Supplemental representations required under FAR 52.204-24, FAR 52.209-11, and FAR 52.223-18 are signed and attached in Appendix B.'
                ]
            },
            {
                id: 'section-9',
                title: 'Proposal Validity Statement',
                status: 'Saved',
                guidance: 'Reaffirm the validity period requested in the solicitation (commonly 120 or 180 days). Mention ability to extend upon Government request.',
                content: [
                    'This proposal, inclusive of price and technical commitments, remains valid for 120 calendar days from the date of submission. Apex Federal Solutions agrees to hold pricing steady during the Government evaluation period.',
                    'The offer or may extend the validity at no additional cost upon written request from the Contracting Officer.'
                ]
            }
        ];

        function isTableOfContentsSection(section) {
            if (!section) {
                return false;
            }
            const title = (section.title || '').toString().trim().toLowerCase();
            const sectionId = (section.id || '').toString().trim().toLowerCase();
            return title === 'table of contents' || sectionId === 'section-toc';
        }

        const defaultSections = (() => {
            if (Array.isArray(proposalContext.sections) && proposalContext.sections.length > 0) {
                return proposalContext.sections
                    .filter(section => !isTableOfContentsSection(section))
                    .map((section, index) => ({
                    id: section.id || `section-${index + 1}`,
                    title: section.title || `Section ${index + 1}`,
                    status: section.status || 'Draft',
                    guidance: section.guidance || '',
                    content: Array.isArray(section.content)
                        ? section.content.slice()
                        : section.content
                            ? [String(section.content)]
                            : [],
                    rawContent: section.raw_content || '',
                    sub_categories: Array.isArray(section.sub_categories) ? section.sub_categories.slice() : []
                    }));
            }
            return fallbackSections
                .filter(section => !isTableOfContentsSection(section))
                .map((section, index) => ({
                id: section.id || `fallback-${index + 1}`,
                title: section.title,
                status: section.status,
                guidance: section.guidance,
                content: Array.isArray(section.content) ? section.content.slice() : [],
                rawContent: section.raw_content || '',
                sub_categories: Array.isArray(section.sub_categories) ? section.sub_categories.slice() : []
                }));
        })();

        const sectionListEl = document.getElementById('sectionList');
        const sectionTitleDisplay = document.getElementById('sectionTitleDisplay');
        const sectionGuidanceDisplay = document.getElementById('sectionGuidanceDisplay');
        const sectionContentDisplay = document.getElementById('sectionContentDisplay');
        const sectionContentEditor = document.getElementById('sectionContentEditor');
        const sectionStatus = document.getElementById('sectionStatus');
        const editorActions = document.getElementById('editorActions');
        const renameSectionBtn = document.getElementById('renameSectionBtn');
        const reviewGenerateBtn = document.getElementById('reviewGenerateBtn');
        const quickSaveBtn = document.getElementById('quickSaveBtn');
        const writeManuallyBtn = document.getElementById('writeManuallyBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveSectionBtn = document.getElementById('saveSectionBtn');
        const addSectionBtn = document.getElementById('addSectionBtn');
        const outlineAnalyzeBtn = document.getElementById('outlineAnalyzeBtn');
        const outlineAnalyzing = document.getElementById('outlineAnalyzing');
        const outlineResultContainer = document.getElementById('outlineResultContainer');
        const outlineContent = document.getElementById('outlineContent');
        const finalProposalPreviewSection = document.getElementById('finalProposalPreviewSection');
        const finalProposalContent = document.getElementById('finalProposalContent');
        const finalProposalStatus = document.getElementById('finalProposalStatus');
        const finalProposalDownloadBtn = document.getElementById('finalProposalDownloadBtn');
        const finalProposalEditBtn = document.getElementById('finalProposalEditBtn');
        let sortableInstance = null;
        const rfpFolderInput = document.getElementById('rfpFolder');
        const selectedRfpLabel = document.getElementById('selectedRfpLabelBottom');
        const rfpUploadLabel = document.getElementById('rfpUploadLabel');
        const generateProposalBtn = document.getElementById('generateProposalBtn');
        const uploadForm = document.getElementById('uploadForm');
        const hiddenSubmit = document.getElementById('generateSubmitHelper');
        const processingStatus = document.getElementById('processingStatus');
        const statusContent = document.getElementById('statusContent');
        const rfpSectionEl = document.getElementById('rfpPreviewSection');
        // PDF viewer is now handled by PDF.js (no iframe needed)
        const rfpPreviewFallback = document.getElementById('rfpPreviewFallback');
        const rfpParseStatus = document.getElementById('rfpParseStatus');
        const rfpTextContainer = document.getElementById('rfpTextContainer');
        const rfpLoadMoreBtn = document.getElementById('rfpLoadMoreBtn');
        const rfpReloadBtn = document.getElementById('rfpReloadBtn');
        const rfpUploadBtn = document.getElementById('rfpUploadBtn');
        const rfpUploadInput = document.getElementById('rfpUploadInput');
        const generalQueryForm = document.getElementById('generalQueryForm');
        const generalQueryInput = document.getElementById('generalQueryInput');
        const generalQueryResponse = document.getElementById('generalQueryResponse');
        const deepAnalysisBtn = document.getElementById('runDeepAnalysisBtn');
        const deepAnalysisStatus = document.getElementById('deepAnalysisStatus');
        const deepAnalysisOutput = document.getElementById('deepAnalysisOutput');
        const deepAnalysisError = document.getElementById('deepAnalysisError');
        let generalQueryHistory = [];
        let activeSectionId = defaultSections[0]?.id || null;
        let isEditing = false;
        let rfpPagesNextStart = null;
        const RFP_PAGE_BATCH = 3;
        const GENERAL_AGENT_STATUS_TEXT = 'Agent is drafting a response…';
        const SECTIONS_STORAGE_PREFIX = 'proposalSections';
        const isLocalStorageAvailable = (() => {
            try {
                const testKey = '__proposal_sections_test__';
                localStorage.setItem(testKey, '1');
                localStorage.removeItem(testKey);
                return true;
            } catch (error) {
                return false;
            }
        })();
        let finalProposalEditable = false;

        function hasSectionContentForSave(section) {
            if (!section) return false;
            if (isEditing && sectionContentEditor) {
                return !!sectionContentEditor.value.trim();
            }
            if (section.rawContent && section.rawContent.trim()) {
                return true;
            }
            if (Array.isArray(section.content)) {
                return section.content.some(paragraph => paragraph && paragraph.trim());
            }
            return false;
        }

        function refreshSectionActionStates() {
            if (!quickSaveBtn) return;
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            const disabled = isEditing || !hasSectionContentForSave(section);
            quickSaveBtn.disabled = !!disabled;
        }

        function markSectionDraft(section) {
            if (!section) return;
            const wasStatus = section.status;
            section.status = 'Draft';
            if (sectionStatus) {
                sectionStatus.textContent = section.status;
            }
            if (wasStatus !== section.status) {
                renderSectionList();
            }
            refreshSectionActionStates();
        }

        if (proposalContext.bid && proposalContext.bid.rfp_label && selectedRfpLabel) {
            selectedRfpLabel.textContent = proposalContext.bid.rfp_label;
        }

        function getActiveBidId() {
            if (proposalContext && proposalContext.bid) {
                if (proposalContext.bid.g_id) {
                    return proposalContext.bid.g_id;
                }
                if (proposalContext.bid.bid_id) {
                    return proposalContext.bid.bid_id;
                }
            }
            if (proposalContext && proposalContext.bid_id) {
                return proposalContext.bid_id;
            }
            return null;
        }

        function getProjectTitle() {
            if (proposalContext && proposalContext.bid) {
                return proposalContext.bid.project_name || proposalContext.bid.b_name || proposalContext.bid.rfp_label || '';
            }
            return proposalContext?.project_name || proposalContext?.bid_name || '';
        }

        function sectionsEligibleForCompilation() {
            return defaultSections.filter(sec => sec.id !== 'requirements-attachments');
        }

        function allSectionsReadyForCompilation() {
            const eligible = sectionsEligibleForCompilation();
            if (!eligible.length) return false;
            return eligible.every((section) => {
                const hasContent = (Array.isArray(section.content) && section.content.length > 0) || !!section.rawContent;
                return hasContent && String(section.status || '').toLowerCase() === 'saved';
            });
        }

        function collectSectionsPayload() {
            return sectionsEligibleForCompilation()
                .map((section) => ({
                    id: section.id,
                    title: section.title,
                    status: section.status,
                    content: Array.isArray(section.content) ? section.content : [],
                    raw_content: section.rawContent || ''
                }))
                .filter((section) => section.content.length > 0 || section.raw_content);
        }

        function setFinalProposalStatus(message, options = {}) {
            if (!finalProposalStatus) return;
            finalProposalStatus.textContent = message || '';
            if (options.muted) {
                finalProposalStatus.classList.add('text-gray-400');
            } else {
                finalProposalStatus.classList.remove('text-gray-400');
            }
        }

        async function compileProposalFromSections() {
            const sectionsPayload = collectSectionsPayload();
            if (!sectionsPayload.length) {
                alert('No section content is available to compile. Generate or write content for at least one section first.');
                return;
            }

            const bidId = getActiveBidId();
            const payload = {
                bid_id: bidId,
                project_title: getProjectTitle(),
                sections: sectionsPayload
            };

            if (processingStatus) {
                processingStatus.classList.remove('hidden');
            }
            if (statusContent) {
                const sectionCount = sectionsPayload.length;
                statusContent.innerHTML = `
                    <div class="rounded-lg bg-cyan-50 px-4 py-2 text-sm text-cyan-800 flex items-center gap-3">
                        <i class="fas fa-diagram-project text-cyan-600"></i>
                        <span>Compiling ${sectionCount} section${sectionCount !== 1 ? 's' : ''} with generated content into a Word document...</span>
                    </div>
                `;
            }

            try {
                const response = await fetch('/api/compile-proposal-sections', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || 'Unable to compile sections. Please try again.');
                }

                if (finalProposalPreviewSection) {
                    finalProposalPreviewSection.classList.remove('hidden');
                }
                if (finalProposalContent) {
                    finalProposalContent.innerHTML = data.html_preview || '<p class="text-sm text-gray-500">Preview unavailable. Download the DOCX to review the compiled proposal.</p>';
                }
                if (finalProposalDownloadBtn) {
                    finalProposalDownloadBtn.dataset.downloadHref = data.download_url || '';
                    finalProposalDownloadBtn.disabled = !data.download_url;
                }
                setFinalProposalStatus(data.message || 'Proposal compiled successfully. Review the preview below.');
            } catch (error) {
                console.error('Compilation error:', error);
                alert(error.message || 'Unable to compile proposal right now.');
            } finally {
                if (processingStatus) {
                    processingStatus.classList.add('hidden');
                }
            }
        }

        function getSectionsStorageKey() {
            const bidId = getActiveBidId();
            return `${SECTIONS_STORAGE_PREFIX}:${bidId || 'general'}`;
        }

        function persistSectionsToStorage() {
            if (!isLocalStorageAvailable) return;
            try {
                const payload = defaultSections.map((section) => ({
                    id: section.id,
                    title: section.title,
                    status: section.status,
                    guidance: section.guidance,
                    content: Array.isArray(section.content) ? section.content : [],
                    rawContent: section.rawContent || ''
                }));
                localStorage.setItem(getSectionsStorageKey(), JSON.stringify(payload));
            } catch (error) {
                console.error('Unable to persist sections locally:', error);
            }
        }

        function hydrateSectionsFromStorage() {
            if (!isLocalStorageAvailable) return;
            try {
                const stored = localStorage.getItem(getSectionsStorageKey());
                if (!stored) return;
                const parsed = JSON.parse(stored);
                if (!Array.isArray(parsed) || parsed.length === 0) return;
                parsed.forEach((savedSection) => {
                    const target = defaultSections.find(sec => sec.id === savedSection.id);
                    if (!target) return;
                    if (Array.isArray(savedSection.content)) {
                        target.content = savedSection.content;
                    }
                    if (savedSection.status) {
                        target.status = savedSection.status;
                    }
                    if (typeof savedSection.rawContent === 'string') {
                        target.rawContent = savedSection.rawContent;
                    }
                });
            } catch (error) {
                console.error('Unable to hydrate sections from local storage:', error);
            }
        }

        async function runDeepAnalysis() {
            const bidId = getActiveBidId();
            if (!bidId) {
                alert('Select or open a bid before running the compliance analysis.');
                return;
            }

            if (deepAnalysisBtn) {
                deepAnalysisBtn.disabled = true;
                deepAnalysisBtn.classList.add('opacity-60', 'cursor-not-allowed');
            }
            if (deepAnalysisStatus) {
                deepAnalysisStatus.classList.remove('hidden');
            }
            if (deepAnalysisError) {
                deepAnalysisError.classList.add('hidden');
                deepAnalysisError.textContent = '';
            }
            if (deepAnalysisOutput) {
                deepAnalysisOutput.innerHTML = '';
            }

            try {
                const response = await fetch('/api/analyze-rfp-master', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ bid_id: bidId })
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.message || 'Unable to analyze the RFP. Please try again.');
                }

                const data = await response.json();
                if (deepAnalysisOutput) {
                    deepAnalysisOutput.innerHTML = data.analysis_html || '<p class="text-sm text-gray-500">No analysis returned.</p>';
                }
            } catch (error) {
                console.error('Deep analysis error:', error);
                if (deepAnalysisError) {
                    deepAnalysisError.textContent = error.message || 'An unexpected error occurred while analyzing the RFP.';
                    deepAnalysisError.classList.remove('hidden');
                }
            } finally {
                if (deepAnalysisStatus) {
                    deepAnalysisStatus.classList.add('hidden');
                }
                if (deepAnalysisBtn) {
                    deepAnalysisBtn.disabled = false;
                    deepAnalysisBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                }
            }
        }

        function renderGeneralQueryChat(statusMessage = '') {
            if (!generalQueryResponse) {
                return;
            }

            let bubbles = [];

            // Show empty state if no messages
            if (!generalQueryHistory.length && !statusMessage) {
                generalQueryResponse.innerHTML = `
                    <div class="flex items-center justify-center h-full text-center px-4">
                        <div class="text-gray-400">
                            <i class="fas fa-comments text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm">Start a conversation with the AI agent</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Render chat messages
            bubbles = generalQueryHistory.map((entry, index) => {
                const isUser = entry.role === 'user';
                const isAssistant = entry.role === 'assistant';
                const content = entry.content ? escapeHtml(entry.content) : '';

                // User message (right aligned, green)
                if (isUser) {
                    return `
                        <div class="flex justify-end group">
                            <div class="max-w-[85%] flex items-start gap-2">
                                <div class="flex-1"></div>
                                <div class="bg-emerald-600 text-white rounded-2xl rounded-tr-sm px-4 py-2.5 shadow-sm">
                                    <p class="text-sm whitespace-pre-wrap leading-relaxed">${content}</p>
                                </div>
                                <button onclick="editUserMessage(${index})" 
                                    class="mt-1 inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600 hover:text-gray-800 transition-all opacity-0 group-hover:opacity-100" 
                                    title="Edit this message">
                                    <i class="fas fa-edit text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }

                // Assistant message (left aligned, white)
                if (isAssistant) {
                    return `
                        <div class="flex justify-start">
                            <div class="max-w-[85%] flex items-start gap-2">
                                <div class="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center flex-shrink-0 mt-1">
                                    <i class="fas fa-robot text-emerald-600 text-xs"></i>
                                </div>
                                <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-2.5 shadow-sm">
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">${content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                return '';
            });

            // Add status message if present
            if (statusMessage) {
                bubbles.push(`
                    <div class="flex justify-start">
                        <div class="max-w-[85%] flex items-start gap-2">
                            <div class="w-6 h-6 rounded-full bg-cyan-100 flex items-center justify-center flex-shrink-0 mt-1">
                                <div class="w-3 h-3 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                            </div>
                            <div class="bg-white border border-cyan-200 rounded-2xl rounded-tl-sm px-4 py-2.5 shadow-sm">
                                <p class="text-sm text-cyan-700">${escapeHtml(statusMessage)}</p>
                            </div>
                        </div>
                    </div>
                `);
            }

            generalQueryResponse.innerHTML = bubbles.join('');

            // Auto-scroll to bottom
            setTimeout(() => {
                generalQueryResponse.scrollTop = generalQueryResponse.scrollHeight;
            }, 100);
        }

        function editUserMessage(index) {
            if (index < 0 || index >= generalQueryHistory.length) return;
            const entry = generalQueryHistory[index];
            if (entry.role !== 'user') return;

            // Set the input value to the message content
            if (generalQueryInput) {
                generalQueryInput.value = entry.content;
                generalQueryInput.focus();

                // Remove the message and all subsequent messages (assistant response)
                generalQueryHistory = generalQueryHistory.slice(0, index);

                // Re-render the chat
                renderGeneralQueryChat();
            }
        }

        function setRfpStatus(message, options = {}) {
            if (!rfpParseStatus) return;
            const { error = false, loading = false } = options;
            if (!message) {
                rfpParseStatus.textContent = '';
                rfpParseStatus.classList.add('hidden');
                rfpParseStatus.classList.remove('animate-pulse', 'text-rose-500');
                rfpParseStatus.classList.add('text-gray-500');
                return;
            }
            rfpParseStatus.textContent = message;
            rfpParseStatus.classList.remove('hidden');
            rfpParseStatus.classList.toggle('animate-pulse', !!loading);
            rfpParseStatus.classList.toggle('text-rose-500', !!error);
            rfpParseStatus.classList.toggle('text-gray-500', !error);
        }

        function renderRfpPages(pages, append = false) {
            if (!rfpTextContainer) return;
            if (!append) {
                rfpTextContainer.innerHTML = '';
            }
            if (!Array.isArray(pages) || pages.length === 0) {
                if (!append) {
                    rfpTextContainer.innerHTML = '<p class="text-sm text-gray-500">No extractable text found for the requested pages.</p>';
                }
                return;
            }

            pages.forEach((page) => {
                const wrapper = document.createElement('article');
                wrapper.className = 'rounded-lg border border-gray-200 bg-gray-50 p-3 shadow-sm';

                const header = document.createElement('header');
                header.className = 'flex items-center justify-between mb-2';

                const pageLabel = document.createElement('span');
                pageLabel.className = 'text-xs font-semibold uppercase tracking-wider text-gray-500';
                pageLabel.textContent = `Page ${page.number}`;

                const charLabel = document.createElement('span');
                charLabel.className = 'text-[10px] text-gray-400';
                charLabel.textContent = `${page.characters || 0} chars`;

                header.appendChild(pageLabel);
                header.appendChild(charLabel);

                const pre = document.createElement('pre');
                pre.className = 'whitespace-pre-wrap text-sm leading-relaxed text-gray-700';
                const pageText = typeof page.text === 'string' ? page.text : '';
                pre.textContent = pageText;
                if (!pageText.trim()) {
                    pre.textContent = 'No selectable text detected on this page.';
                    pre.classList.add('text-gray-400', 'italic');
                }

                wrapper.appendChild(header);
                wrapper.appendChild(pre);
                rfpTextContainer.appendChild(wrapper);
            });
        }

        function fetchRfpPages(start = 1, limit = RFP_PAGE_BATCH, append = false) {
            if (!rfpSectionEl) return;
            const apiEndpoint = rfpSectionEl.dataset.api;
            if (!apiEndpoint) {
                setRfpStatus('No RFP file is linked to this workspace yet.');
                if (rfpLoadMoreBtn) {
                    rfpLoadMoreBtn.classList.add('hidden');
                }
                return;
            }

            const url = new URL(apiEndpoint, window.location.origin);
            if (start) url.searchParams.set('start', start);
            if (limit) url.searchParams.set('limit', limit);

            setRfpStatus('Loading RFP pages…', { loading: true });

            fetch(url.toString(), { headers: { 'Accept': 'application/json' } })
                .then(async (response) => {
                    const contentType = response.headers.get('content-type') || '';
                    let payload = null;
                    if (contentType.includes('application/json')) {
                        payload = await response.json();
                    } else {
                        const text = await response.text();
                        payload = { error: text };
                    }
                    if (!response.ok) {
                        const errorMessage = payload && payload.message ? payload.message : 'Failed to load RFP content.';
                        throw new Error(errorMessage);
                    }
                    return payload;
                })
                .then((data) => {
                    const pages = Array.isArray(data.pages) ? data.pages : [];
                    if (pages.length > 0) {
                        const first = pages[0].number;
                        const last = pages[pages.length - 1].number;
                        const total = data.total_pages || last;
                        setRfpStatus(`Showing pages ${first}–${last} of ${total}`);
                        renderRfpPages(pages, append);
                    } else {
                        if ((data.total_pages || 0) === 0) {
                            setRfpStatus('No pages available in this PDF.');
                        } else {
                            setRfpStatus('No extractable text found in the requested pages.');
                        }
                        if (!append) {
                            rfpTextContainer.innerHTML = '<p class="text-sm text-gray-500">No extractable text found for the requested pages.</p>';
                        }
                    }

                    rfpPagesNextStart = data.next_start || null;
                    if (rfpLoadMoreBtn) {
                        if (rfpPagesNextStart) {
                            rfpLoadMoreBtn.classList.remove('hidden');
                            rfpLoadMoreBtn.disabled = false;
                        } else {
                            rfpLoadMoreBtn.classList.add('hidden');
                        }
                    }

                    // Load PDF using PDF.js instead of iframe
                    if (rfpSectionEl.dataset.viewUrl && !rfpSectionEl.dataset.pdfLoaded) {
                        loadPdfWithJs(rfpSectionEl.dataset.viewUrl);
                        rfpSectionEl.dataset.pdfLoaded = '1';
                    }
                    if (rfpPreviewFallback) {
                        rfpPreviewFallback.classList.add('hidden');
                    }
                })
                .catch((error) => {
                    console.error('Error loading RFP preview:', error);
                    setRfpStatus('', { error: true });
                    if (!append && rfpTextContainer) {
                        rfpTextContainer.innerHTML = '';
                    }
                    if (rfpLoadMoreBtn) {
                        rfpLoadMoreBtn.classList.add('hidden');
                    }
                    if (rfpPreviewFallback) {
                        rfpPreviewFallback.classList.remove('hidden');
                        rfpPreviewFallback.textContent = 'PDF preview unavailable. Download the file from the bid dashboard.';
                    }
                })
                .finally(() => {
                    if (rfpParseStatus) {
                        rfpParseStatus.classList.remove('animate-pulse');
                    }
                });
        }

        rfpLoadMoreBtn?.addEventListener('click', () => {
            if (!rfpPagesNextStart) return;
            fetchRfpPages(rfpPagesNextStart, RFP_PAGE_BATCH, true);
        });

        rfpReloadBtn?.addEventListener('click', () => {
            rfpPagesNextStart = null;
            fetchRfpPages(1, RFP_PAGE_BATCH, false);
        });

        rfpUploadBtn?.addEventListener('click', () => {
            rfpUploadInput?.click();
        });

        rfpUploadInput?.addEventListener('change', () => {
            if (!rfpSectionEl || !rfpSectionEl.dataset.bidId) {
                setRfpStatus('No project is selected for upload.', { error: true });
                rfpUploadInput.value = '';
                return;
            }
            const file = rfpUploadInput.files && rfpUploadInput.files[0];
            if (!file) {
                return;
            }
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                setRfpStatus('Please upload a PDF file.', { error: true });
                rfpUploadInput.value = '';
                return;
            }

            const gId = rfpSectionEl.dataset.bidId;
            const formData = new FormData();
            formData.append('file', file);

            setRfpStatus('Uploading RFP...', { loading: true });

            fetch(`/api/rfp-file/${gId}/upload`, {
                method: 'POST',
                body: formData,
            })
                .then(async (response) => {
                    let payload = {};
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        payload = await response.json();
                    }
                    if (!response.ok || payload.error || payload.success === false) {
                        const message = payload.message || 'Upload failed. Please try again.';
                        throw new Error(message);
                    }
                    return payload;
                })
                .then((data) => {
                    const pages = Array.isArray(data.pages) ? data.pages : [];
                    rfpPagesNextStart = data.next_start || null;
                    if (pages.length > 0) {
                        renderRfpPages(pages, false);
                        const first = pages[0].number || 1;
                        const last = pages[pages.length - 1].number || first;
                        const total = data.total_pages || last;
                        setRfpStatus(`Showing pages ${first}–${last} of ${total}`);
                        if (rfpLoadMoreBtn) {
                            if (rfpPagesNextStart) {
                                rfpLoadMoreBtn.classList.remove('hidden');
                                rfpLoadMoreBtn.disabled = false;
                            } else {
                                rfpLoadMoreBtn.classList.add('hidden');
                            }
                        }
                    } else {
                        setRfpStatus('Upload complete. Parsing PDF...', { loading: true });
                        fetchRfpPages(1, RFP_PAGE_BATCH, false);
                    }

                    // Reload PDF after upload
                    if (rfpSectionEl.dataset.viewUrl) {
                        delete rfpSectionEl.dataset.pdfLoaded;
                        loadPdfWithJs(`${rfpSectionEl.dataset.viewUrl}?t=${Date.now()}`);
                    }
                })
                .catch((error) => {
                    console.error('RFP upload failed:', error);
                    setRfpStatus(error.message || 'Upload failed. Please try again.', { error: true });
                })
                .finally(() => {
                    rfpUploadInput.value = '';
                    if (rfpParseStatus) {
                        rfpParseStatus.classList.remove('animate-pulse');
                    }
                });
        });

        if (rfpSectionEl && rfpSectionEl.dataset.api) {
            fetchRfpPages(1, RFP_PAGE_BATCH, false);
        } else if (rfpSectionEl) {
            rfpReloadBtn?.setAttribute('disabled', 'disabled');
            rfpReloadBtn?.classList.add('opacity-50', 'cursor-not-allowed');
            setRfpStatus('No RFP file is linked to this workspace yet.');
        }

        function escapeHtml(text) {
            const p = document.createElement('p');
            p.textContent = text;
            return p.innerHTML;
        }

        function renderSectionList() {
            if (!sectionListEl) return;
            sectionListEl.innerHTML = '';
            defaultSections.forEach((section, idx) => {
                const li = document.createElement('li');
                li.className = `relative flex items-center gap-3 px-6 py-4 cursor-pointer transition ${section.id === activeSectionId ? 'section-active' : 'hover:bg-gray-50'}`;
                li.dataset.sectionId = section.id;
                const statusLabel = section.status || 'Draft';

                // Create drag handle
                const dragHandle = document.createElement('button');
                dragHandle.className = 'drag-handle text-gray-300 hover:text-gray-500';
                dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';

                // Create dropdown button
                const dropdownBtn = document.createElement('button');
                dropdownBtn.className = 'section-dropdown-btn text-gray-400 hover:text-gray-600 transition p-1.5 rounded hover:bg-gray-100';
                dropdownBtn.innerHTML = '<i class="fas fa-ellipsis-v text-sm"></i>';
                dropdownBtn.title = 'Section options';
                dropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSectionDropdown(section.id);
                });

                // Create dropdown menu
                const dropdownMenu = document.createElement('div');
                dropdownMenu.id = `dropdown-${section.id}`;
                dropdownMenu.className = 'hidden absolute right-2 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50 py-1';
                const isFirst = idx === 0;
                const isLast = idx === defaultSections.length - 1;
                dropdownMenu.innerHTML = `
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" data-action="rename" data-section-id="${section.id}">
                        <i class="fas fa-edit text-xs"></i>
                        <span>Rename</span>
                    </button>
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" data-action="duplicate" data-section-id="${section.id}">
                        <i class="fas fa-copy text-xs"></i>
                        <span>Duplicate</span>
                    </button>
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm ${isFirst ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'} flex items-center gap-2" data-action="move-up" data-section-id="${section.id}" ${isFirst ? 'disabled' : ''}>
                        <i class="fas fa-arrow-up text-xs"></i>
                        <span>Move Up</span>
                    </button>
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm ${isLast ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'} flex items-center gap-2" data-action="move-down" data-section-id="${section.id}" ${isLast ? 'disabled' : ''}>
                        <i class="fas fa-arrow-down text-xs"></i>
                        <span>Move Down</span>
                    </button>
                    <div class="border-t border-gray-200 my-1"></div>
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2" data-action="delete" data-section-id="${section.id}">
                        <i class="fas fa-trash-alt text-xs"></i>
                        <span>Delete</span>
                    </button>
                `;

                // Add event listeners to dropdown items
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (item.disabled) return;
                        const action = item.dataset.action;
                        const sectionId = item.dataset.sectionId;
                        handleSectionAction(action, sectionId);
                        closeAllDropdowns();
                    });
                });

                // Create button container
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex items-center gap-2 relative';
                buttonContainer.appendChild(dropdownBtn);
                buttonContainer.appendChild(dragHandle);
                buttonContainer.appendChild(dropdownMenu);

                li.innerHTML = `
                    <span class="text-sm font-semibold text-gray-400 w-6">${idx + 1}.</span>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">${section.title}</p>
                        <p class="text-xs text-gray-500 capitalize">${statusLabel}</p>
                    </div>
                `;
                li.appendChild(buttonContainer);

                li.addEventListener('click', (e) => {
                    // Don't activate section if clicking on dropdown or menu
                    if (e.target.closest('.section-dropdown-btn') ||
                        e.target.closest('.dropdown-menu')) {
                        return;
                    }
                    if (isEditing) return;
                    activeSectionId = section.id;
                    closeAllDropdowns();
                    renderSectionList();
                    renderActiveSection();
                });
                sectionListEl.appendChild(li);
            });

            // Add Requirements and Attachments section at the end
            const reqAttachId = 'requirements-attachments';
            const reqAttachLi = document.createElement('li');
            reqAttachLi.className = `relative flex items-center gap-3 px-6 py-4 cursor-pointer transition ${reqAttachId === activeSectionId ? 'section-active' : 'hover:bg-gray-50'}`;
            reqAttachLi.dataset.sectionId = reqAttachId;

            reqAttachLi.innerHTML = `
                <span class="text-sm font-semibold text-gray-400 w-6">${defaultSections.length + 1}.</span>
                <div class="flex-1">
                    <p class="font-medium text-gray-900">Requirements and Attachments</p>
                    <p class="text-xs text-gray-500">Special Section</p>
                </div>
            `;

            reqAttachLi.addEventListener('click', (e) => {
                if (isEditing) return;
                activeSectionId = reqAttachId;
                closeAllDropdowns();
                renderSectionList();
                renderActiveSection();
            });

            sectionListEl.appendChild(reqAttachLi);
        }

        function toggleSectionDropdown(sectionId) {
            const dropdown = document.getElementById(`dropdown-${sectionId}`);
            if (!dropdown) {
                return;
            }
            const shouldShow = dropdown.classList.contains('hidden');
            closeAllDropdowns();
            if (shouldShow) {
                dropdown.classList.remove('hidden');
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                dropdown.classList.add('hidden');
            });
        }

        function handleSectionAction(action, sectionId) {
            const section = defaultSections.find(sec => sec.id === sectionId);
            if (!section) return;

            switch (action) {
                case 'rename':
                    const newTitle = prompt('Rename section', section.title);
                    if (newTitle && newTitle.trim()) {
                        section.title = newTitle.trim();
                        renderSectionList();
                        renderActiveSection();
                        persistSectionsToStorage();
                    }
                    break;
                case 'duplicate':
                    const newId = `section-${Date.now()}`;
                    const duplicatedSection = {
                        id: newId,
                        title: `${section.title} (Copy)`,
                        status: 'Draft',
                        guidance: section.guidance || '',
                        content: Array.isArray(section.content) ? [...section.content] : [],
                        rawContent: section.rawContent || '',
                        sub_categories: Array.isArray(section.sub_categories) ? [...section.sub_categories] : []
                    };
                    const currentIndex = defaultSections.findIndex(sec => sec.id === sectionId);
                    defaultSections.splice(currentIndex + 1, 0, duplicatedSection);
                    activeSectionId = newId;
                    renderSectionList();
                    renderActiveSection();
                    ensureSortable();
                    persistSectionsToStorage();
                    break;
                case 'move-up':
                    const upIndex = defaultSections.findIndex(sec => sec.id === sectionId);
                    if (upIndex > 0) {
                        [defaultSections[upIndex - 1], defaultSections[upIndex]] = [defaultSections[upIndex], defaultSections[upIndex - 1]];
                        renderSectionList();
                        renderActiveSection();
                        ensureSortable();
                        persistSectionsToStorage();
                    }
                    break;
                case 'move-down':
                    const downIndex = defaultSections.findIndex(sec => sec.id === sectionId);
                    if (downIndex < defaultSections.length - 1) {
                        [defaultSections[downIndex], defaultSections[downIndex + 1]] = [defaultSections[downIndex + 1], defaultSections[downIndex]];
                        renderSectionList();
                        renderActiveSection();
                        ensureSortable();
                        persistSectionsToStorage();
                    }
                    break;
                case 'delete':
                    deleteSection(sectionId);
                    break;
            }
        }

        function deleteSection(sectionId) {
            if (!sectionId) return;

            const section = defaultSections.find(sec => sec.id === sectionId);
            if (!section) return;

            // Confirm deletion
            if (!confirm(`Are you sure you want to delete "${section.title}"? This action cannot be undone.`)) {
                return;
            }

            // Find the index of the section to delete
            const sectionIndex = defaultSections.findIndex(sec => sec.id === sectionId);

            // If deleting the active section, switch to another one
            if (sectionId === activeSectionId) {
                if (defaultSections.length > 1) {
                    // Switch to the previous section if available, otherwise the next one
                    if (sectionIndex > 0) {
                        activeSectionId = defaultSections[sectionIndex - 1].id;
                    } else if (sectionIndex < defaultSections.length - 1) {
                        activeSectionId = defaultSections[sectionIndex + 1].id;
                    } else {
                        activeSectionId = null;
                    }
                } else {
                    activeSectionId = null;
                }
            }

            // Remove the section from the array
            defaultSections.splice(sectionIndex, 1);

            // Re-render the list and active section
            renderSectionList();
            if (activeSectionId) {
                renderActiveSection();
            } else {
                // If no sections left, clear the active section display
                sectionTitleDisplay.textContent = 'No sections';
                sectionGuidanceDisplay.innerHTML = '<span class="text-gray-400 italic">Add a new section to get started.</span>';
                sectionContentDisplay.innerHTML = '<p class="text-gray-400 italic">No sections available. Click the + button to add a new section.</p>';
                sectionStatus.textContent = '';
            }

            // Re-initialize sortable after deletion
            ensureSortable();
            persistSectionsToStorage();
        }

        function renderActiveSection() {
            const requirementsAttachmentsSection = document.getElementById('requirementsAttachmentsSection');
            const regularSectionDisplay = document.getElementById('regularSectionDisplay');

            // Handle Requirements and Attachments special section
            if (activeSectionId === 'requirements-attachments') {
                if (requirementsAttachmentsSection) {
                    requirementsAttachmentsSection.classList.remove('hidden');
                }
                if (regularSectionDisplay) {
                    regularSectionDisplay.classList.add('hidden');
                }
                return;
            }

            // Handle regular sections
            if (requirementsAttachmentsSection) {
                requirementsAttachmentsSection.classList.add('hidden');
            }
            if (regularSectionDisplay) {
                regularSectionDisplay.classList.remove('hidden');
            }

            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            sectionTitleDisplay.textContent = section.title;
            sectionGuidanceDisplay.innerHTML = section.guidance ? escapeHtml(section.guidance) : '<span class="text-gray-400 italic">No guidance provided yet.</span>';
            sectionStatus.textContent = section.status || 'Draft';
            refreshSectionActionStates();
            
            // Check if this is Corporate Qualifications section that needs HTML rendering
            const isCorporateQualifications = (
                section.id === 'section-corporate-qualifications' || 
                section.id === 'section-corporate' ||
                (section.title && section.title.toLowerCase().includes('corporate qualifications'))
            );
            
            if (section.content && section.content.length > 0) {
                // For Corporate Qualifications with raw HTML content, render HTML directly
                if (isCorporateQualifications && section.rawContent) {
                    sectionContentDisplay.innerHTML = `
                        <div class="prose max-w-none text-gray-700">
                            ${section.rawContent}
                        </div>
                    `;
                } else {
                    sectionContentDisplay.innerHTML = section.content.map(paragraph => `<p>${escapeHtml(paragraph)}</p>`).join('');
                }
            } else {
                sectionContentDisplay.innerHTML = '<p class="text-gray-400 italic">Use the generator to draft content from the RFP or type manually.</p>';
            }
            sectionContentEditor.value = section.content ? section.content.join('\n\n') : '';

            // Populate sub-category dropdown
            const subCategorySelect = document.getElementById('subCategorySelect');
            const analyzeSubCategoryBtn = document.getElementById('analyzeSubCategoryBtn');
            const subCategoryContentDisplay = document.getElementById('subCategoryContentDisplay');

            if (subCategorySelect) {
                subCategorySelect.innerHTML = '<option value="">-- Select Sub-Category --</option>';
                if (section.sub_categories && Array.isArray(section.sub_categories) && section.sub_categories.length > 0) {
                    section.sub_categories.forEach(subCat => {
                        const option = document.createElement('option');
                        option.value = subCat.id;
                        option.textContent = subCat.title;
                        option.dataset.subcategoryId = subCat.id;
                        option.dataset.subcategoryTitle = subCat.title;
                        subCategorySelect.appendChild(option);
                    });
                }
            }

            // Reset sub-category UI
            if (analyzeSubCategoryBtn) {
                analyzeSubCategoryBtn.disabled = true;
            }
            if (subCategoryContentDisplay) {
                subCategoryContentDisplay.classList.add('hidden');
            }
            if (outlineResultContainer) {
                outlineResultContainer.classList.add('hidden');
            }
            if (outlineContent) {
                outlineContent.textContent = '';
            }
            if (outlineAnalyzing) {
                outlineAnalyzing.classList.add('hidden');
            }
            if (outlineAnalyzeBtn) {
                outlineAnalyzeBtn.disabled = false;
            }
        }

        function toggleEditor(editMode) {
            isEditing = editMode;
            if (editMode) {
                sectionContentDisplay.classList.add('hidden');
                sectionContentEditor.classList.remove('hidden');
                editorActions.classList.remove('hidden');
            } else {
                sectionContentDisplay.classList.remove('hidden');
                sectionContentEditor.classList.add('hidden');
                editorActions.classList.add('hidden');
            }
            refreshSectionActionStates();
        }

        function ensureSortable() {
            if (!sectionListEl) return;
            // Destroy existing instance if it exists
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }
            // Create new Sortable instance
            sortableInstance = new Sortable(sectionListEl, {
                animation: 160,
                handle: '.drag-handle',
                onEnd: (evt) => {
                    const [moved] = defaultSections.splice(evt.oldIndex, 1);
                    defaultSections.splice(evt.newIndex, 0, moved);
                    renderSectionList();
                    renderActiveSection();
                    persistSectionsToStorage();
                }
            });
        }

        renameSectionBtn?.addEventListener('click', () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            const newTitle = prompt('Rename section', section.title);
            if (newTitle && newTitle.trim()) {
                section.title = newTitle.trim();
                renderSectionList();
                renderActiveSection();
            }
        });

        deepAnalysisBtn?.addEventListener('click', runDeepAnalysis);

        reviewGenerateBtn?.addEventListener('click', async () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            
            // Disable button during generation
            if (reviewGenerateBtn) {
                reviewGenerateBtn.disabled = true;
            }
            
            // Show loading state
            sectionContentDisplay.innerHTML = `
                <p class="text-gray-700 leading-relaxed">Drafting narrative from the attached RFP &amp; company profile...</p>
            `;
            
            const bidId = getActiveBidId();
            const company = (proposalContext && proposalContext.company) ? proposalContext.company : '';
            const contactEmail = (proposalContext && proposalContext.contactEmail) ? proposalContext.contactEmail : '';
            
            try {
                const response = await fetch('/api/generate-section-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section_id: section.id,
                        section_title: section.title,
                        bid_id: bidId,
                        company: company,
                        contact_email: contactEmail,
                    }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to generate section content.');
                }
                
                // Update section content with generated paragraphs
                const paragraphs = data.content || [];
                const rawContent = data.raw || '';
                
                // Check if this is Corporate Qualifications section that needs HTML rendering
                const isCorporateQualifications = (
                    section.id === 'section-corporate-qualifications' || 
                    section.id === 'section-corporate' ||
                    (section.title && section.title.toLowerCase().includes('corporate qualifications'))
                );
                
                if (paragraphs.length > 0) {
                    section.content = paragraphs;
                    
                    // For Corporate Qualifications, render HTML directly (tables, headings)
                    if (isCorporateQualifications && rawContent) {
                        // Style the HTML content appropriately
                        sectionContentDisplay.innerHTML = `
                            <div class="prose max-w-none text-gray-700">
                                ${rawContent}
                            </div>
                        `;
                        // Store raw HTML in section for later use
                        section.rawContent = rawContent;
                    } else {
                        section.rawContent = '';
                        sectionContentDisplay.innerHTML = paragraphs.map(paragraph => `<p class="text-gray-700 leading-relaxed">${escapeHtml(paragraph)}</p>`).join('');
                    }
                } else {
                    section.content = ['AI drafting completed. Customize this section to highlight your differentiators.'];
                    section.rawContent = '';
                    sectionContentDisplay.innerHTML = section.content.map(paragraph => `<p class="text-gray-700 leading-relaxed">${escapeHtml(paragraph)}</p>`).join('');
                }

                markSectionDraft(section);
                
                persistSectionsToStorage();
            } catch (error) {
                console.error('Error generating section content:', error);
                sectionContentDisplay.innerHTML = `
                    <p class="text-red-600 leading-relaxed">Error: ${escapeHtml(error.message || 'Failed to generate content. Please try again.')}</p>
                `;
            } finally {
                // Re-enable button
                if (reviewGenerateBtn) {
                    reviewGenerateBtn.disabled = false;
                }
            }
        });

        writeManuallyBtn?.addEventListener('click', () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (section) {
                markSectionDraft(section);
            }
            toggleEditor(true);
            sectionContentEditor.focus();
        });

        outlineAnalyzeBtn?.addEventListener('click', async () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) {
                alert('Select a section to analyze first.');
                return;
            }

            if (outlineResultContainer) {
                outlineResultContainer.classList.add('hidden');
            }
            if (outlineContent) {
                outlineContent.textContent = '';
            }

            if (outlineAnalyzeBtn) {
                outlineAnalyzeBtn.disabled = true;
            }
            if (outlineAnalyzing) {
                outlineAnalyzing.classList.remove('hidden');
            }

            const bidId = getActiveBidId();

            try {
                const response = await fetch('/api/analyze-section-outline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section_id: section.id,
                        section_title: section.title,
                        bid_id: bidId,
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to analyze section requirements.');
                }

                const outputText = (data.output || data.raw || '').trim();
                if (outlineContent) {
                    outlineContent.textContent = outputText || 'Analysis complete. No explicit requirements were returned.';
                }

                if (outlineResultContainer) {
                    outlineResultContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error analyzing section outline:', error);
                alert(`Unable to analyze RFP requirements: ${error.message || error}`);
            } finally {
                if (outlineAnalyzing) {
                    outlineAnalyzing.classList.add('hidden');
                }
                if (outlineAnalyzeBtn) {
                    outlineAnalyzeBtn.disabled = false;
                }
            }
        });

        cancelEditBtn?.addEventListener('click', () => {
            toggleEditor(false);
        });

        sectionContentEditor?.addEventListener('input', () => {
            if (!isEditing) return;
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (section) {
                markSectionDraft(section);
            }
        });

        saveSectionBtn?.addEventListener('click', () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            const value = sectionContentEditor.value.trim();
            section.content = value ? value.split(/\n\s*\n/) : [];
            section.rawContent = '';
            section.status = 'Saved';
            persistSectionsToStorage();
            toggleEditor(false);
            renderSectionList();
            renderActiveSection();
            refreshSectionActionStates();
        });

        quickSaveBtn?.addEventListener('click', () => {
            if (isEditing) {
                return;
            }
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            if (!hasSectionContentForSave(section)) {
                alert('Generate or enter content before saving this section.');
                return;
            }
            section.status = 'Saved';
            if (sectionStatus) {
                sectionStatus.textContent = 'Saved';
            }
            persistSectionsToStorage();
            renderSectionList();
            refreshSectionActionStates();
        });

        addSectionBtn?.addEventListener('click', () => {
            const id = `section-${Date.now()}`;
            defaultSections.push({
                id,
                title: 'New Section',
                status: 'Draft',
                guidance: 'Add guidance for this new section.',
                content: [],
                rawContent: '',
                sub_categories: []
            });
            activeSectionId = id;
            renderSectionList();
            renderActiveSection();
            persistSectionsToStorage();
        });

        // Sub-category dropdown change handler
        const subCategorySelect = document.getElementById('subCategorySelect');
        const analyzeSubCategoryBtn = document.getElementById('analyzeSubCategoryBtn');
        const subCategoryAnalyzing = document.getElementById('subCategoryAnalyzing');
        const subCategoryContentDisplay = document.getElementById('subCategoryContentDisplay');
        const subCategoryTitleDisplay = document.getElementById('subCategoryTitleDisplay');
        const subCategoryContentText = document.getElementById('subCategoryContentText');

        subCategorySelect?.addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            if (analyzeSubCategoryBtn) {
                analyzeSubCategoryBtn.disabled = !selectedValue;
            }
            if (!selectedValue && subCategoryContentDisplay) {
                subCategoryContentDisplay.classList.add('hidden');
            }
        });

        // Analyze sub-category with AI
        analyzeSubCategoryBtn?.addEventListener('click', async () => {
            const selectedOption = subCategorySelect?.options[subCategorySelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                alert('Please select a sub-category first.');
                return;
            }

            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) {
                alert('No section selected.');
                return;
            }

            const subcategoryId = selectedOption.value;
            const subcategoryTitle = selectedOption.dataset.subcategoryTitle || selectedOption.textContent;
            const bidId = getActiveBidId();

            // Show loading state
            if (analyzeSubCategoryBtn) {
                analyzeSubCategoryBtn.disabled = true;
            }
            if (subCategoryAnalyzing) {
                subCategoryAnalyzing.classList.remove('hidden');
            }

            try {
                const response = await fetch('/api/analyze-subcategory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section_id: section.id,
                        subcategory_id: subcategoryId,
                        subcategory_title: subcategoryTitle,
                        bid_id: bidId
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to analyze sub-category');
                }

                // Display the analyzed content
                if (subCategoryTitleDisplay) {
                    subCategoryTitleDisplay.textContent = subcategoryTitle;
                }
                if (subCategoryContentText) {
                    // Format the content - preserve line breaks
                    const formattedContent = data.content
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0)
                        .map(line => `<p>${escapeHtml(line)}</p>`)
                        .join('');
                    subCategoryContentText.innerHTML = formattedContent || '<p class="text-gray-500 italic">No content generated.</p>';
                }
                if (subCategoryContentDisplay) {
                    subCategoryContentDisplay.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error analyzing sub-category:', error);
                alert(`Error analyzing sub-category: ${error.message}`);
            } finally {
                // Hide loading state
                if (analyzeSubCategoryBtn) {
                    analyzeSubCategoryBtn.disabled = false;
                }
                if (subCategoryAnalyzing) {
                    subCategoryAnalyzing.classList.add('hidden');
                }
            }
        });

        if (rfpFolderInput) {
            rfpFolderInput.addEventListener('change', (event) => {
                const count = event.target.files.length;
                if (!count) {
                    selectedRfpLabel.textContent = 'No RFP attached';
                    rfpUploadLabel.textContent = 'Drop or browse PDFs';
                } else if (count === 1) {
                    selectedRfpLabel.textContent = event.target.files[0].name;
                    rfpUploadLabel.textContent = event.target.files[0].name;
                } else {
                    selectedRfpLabel.textContent = `${count} RFP documents attached`;
                    rfpUploadLabel.textContent = `${count} files ready`;
                }
            });
        }

        generateProposalBtn?.addEventListener('click', () => {
            // Check if any sections have generated content
            const sectionsPayload = collectSectionsPayload();
            if (sectionsPayload.length > 0) {
                // Save all sections to storage before compiling
                persistSectionsToStorage();
                compileProposalFromSections();
                return;
            }

            // Fallback to old RFP upload flow if no sections have content
            if (!uploadForm) return;
            if (!rfpFolderInput || rfpFolderInput.files.length === 0) {
                alert('Generate content for at least one section before creating a proposal, or attach an RFP PDF file.');
                return;
            }

            processingStatus.classList.remove('hidden');
            statusContent.innerHTML = `
                <div class="rounded-lg bg-cyan-100 px-4 py-2 flex items-center gap-3">
                    <i class="fas fa-file-import text-cyan-700"></i>
                    <span>Importing ${rfpFolderInput.files.length} RFP file(s) and mapping required sections...</span>
                </div>
                <div class="rounded-lg bg-cyan-100 px-4 py-2 flex items-center gap-3">
                    <i class="fas fa-robot text-cyan-700"></i>
                    <span>Generating draft narrative and compliance checklist.</span>
                </div>
            `;
            hiddenSubmit?.click();
        });

        function renderInitial() {
            renderSectionList();
            renderActiveSection();
            ensureSortable();

            // Auto-load RFP files from database if available
            if (rfpSectionEl && rfpSectionEl.dataset.bidId && rfpSectionEl.dataset.api) {
                // Load RFP preview automatically
                fetchRfpPages(1, RFP_PAGE_BATCH, false);
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.section-dropdown-btn') && !e.target.closest('[id^="dropdown-"]')) {
                    closeAllDropdowns();
                }
            });
        }

        hydrateSectionsFromStorage();
        renderInitial();

        finalProposalDownloadBtn?.addEventListener('click', () => {
            const href = finalProposalDownloadBtn.dataset.downloadHref;
            if (!href) {
                alert('Generate the proposal first to enable downloads.');
                return;
            }
            window.open(href, '_blank');
        });

        finalProposalEditBtn?.addEventListener('click', () => {
            finalProposalEditable = !finalProposalEditable;
            if (finalProposalContent) {
                if (finalProposalEditable) {
                    finalProposalContent.setAttribute('contenteditable', 'true');
                    finalProposalContent.classList.add('ring', 'ring-emerald-300');
                } else {
                    finalProposalContent.removeAttribute('contenteditable');
                    finalProposalContent.classList.remove('ring', 'ring-emerald-300');
                }
            }
            if (finalProposalEditBtn) {
                finalProposalEditBtn.classList.toggle('btn-secondary', finalProposalEditable);
                const label = finalProposalEditBtn.querySelector('span');
                if (label) {
                    label.textContent = finalProposalEditable ? 'Lock Preview' : 'Edit Preview';
                }
            }
        });

        // Load saved requirements from localStorage on page load
        loadRequirementsFromStorage();

        renderGeneralQueryChat();

        generalQueryForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!generalQueryInput) {
                return;
            }

            const message = generalQueryInput.value.trim();
            if (!message) {
                generalQueryInput.focus();
                return;
            }

            const previousHistory = generalQueryHistory.slice(-10).map((entry) => ({
                role: entry.role,
                content: entry.content,
            }));

            generalQueryHistory.push({ role: 'user', content: message });
            if (generalQueryHistory.length > 20) {
                generalQueryHistory = generalQueryHistory.slice(-20);
            }

            generalQueryInput.value = '';
            generalQueryInput.setAttribute('disabled', 'disabled');
            const submitBtn = generalQueryForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-70', 'cursor-not-allowed');
            }

            renderGeneralQueryChat(GENERAL_AGENT_STATUS_TEXT);

            try {
                const response = await fetch('/api/proposals-agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message,
                        history: previousHistory,
                        context: proposalContext || {},
                    }),
                });

                let payload = null;
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    payload = await response.json();
                } else {
                    const text = await response.text();
                    payload = { error: text || 'Unexpected response format.' };
                }

                if (!response.ok || (payload && payload.error)) {
                    const errorMessage = payload?.message || payload?.error || 'Unable to get agent response.';
                    throw new Error(errorMessage);
                }

                const reply = (payload && payload.reply ? String(payload.reply) : '').trim();
                generalQueryHistory.push({
                    role: 'assistant',
                    content: reply || 'I was unable to craft a response. Please try asking again with more detail.',
                });
            } catch (error) {
                generalQueryHistory.push({
                    role: 'assistant',
                    content: `Unable to complete your request: ${error?.message || error}`,
                });
            } finally {
                if (generalQueryHistory.length > 20) {
                    generalQueryHistory = generalQueryHistory.slice(-20);
                }

                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
                generalQueryInput.removeAttribute('disabled');
                renderGeneralQueryChat();
                generalQueryInput.focus();
            }
        });

        // Auto-resize textarea
        if (generalQueryInput) {
            // Auto-resize on input
            generalQueryInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 128) + 'px'; // Max height ~32px * 4 rows
            });

            // Handle Enter key (submit on Enter, new line on Shift+Enter)
            generalQueryInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (generalQueryForm) {
                        generalQueryForm.dispatchEvent(new Event('submit'));
                    }
                }
            });
        }

        // Initialize chat on page load
        renderGeneralQueryChat();

        function refreshProposals() {
            fetch('{{ url_for("proposals_making") }}?refresh=1')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('proposalsList');
                    if (!list) return;
                    if (data.proposals && data.proposals.length > 0) {
                        list.innerHTML = data.proposals.map(p => `
                            <article class="rounded-xl border border-gray-200 px-4 py-4 hover:border-emerald-200 hover:shadow-sm transition card-hover">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">${p.name || 'Proposal'}</h4>
                                        <div class="mt-2 flex flex-wrap gap-x-6 gap-y-1 text-sm text-gray-600">
                                            <span class="flex items-center gap-2"><i class="fas fa-file-pdf text-red-500"></i>${p.rfp_name || '—'}</span>
                                            <span class="flex items-center gap-2"><i class="fas fa-building text-gray-400"></i>${p.company || 'N/A'}</span>
                                            <span class="flex items-center gap-2"><i class="fas fa-clock text-gray-400"></i>${p.created_at || 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <a href="${p.download_url || '#'}" class="btn-primary inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white">
                                            <i class="fas fa-download"></i>
                                            Download
                                        </a>
                                    </div>
                                </div>
                            </article>
                        `).join('');
                    } else {
                        list.innerHTML = '<p class="text-center text-gray-500">No proposals generated yet.</p>';
                    }
                })
                .catch(err => {
                    console.error('Error refreshing proposals:', err);
                });
        }

        // Requirements and Attachments handlers
        const analyzeRequirementsBtn = document.getElementById('analyzeRequirementsBtn');
        const requirementsAnalyzing = document.getElementById('requirementsAnalyzing');
        const requirementsDisplay = document.getElementById('requirementsDisplay');
        const requirementsItemsList = document.getElementById('requirementsItemsList');
        let requirementsData = [];

        // Get localStorage key for requirements based on bid ID
        function getRequirementsStorageKey() {
            const bidId = getActiveBidId();
            return bidId ? `requirements_data_${bidId}` : 'requirements_data_default';
        }

        // Save requirements to localStorage
        function saveRequirementsToStorage() {
            try {
                const storageKey = getRequirementsStorageKey();
                // Create a serializable copy without File objects
                const serializableData = requirementsData.map(categoryData => ({
                    category: categoryData.category,
                    items: categoryData.items ? categoryData.items.map(item => ({
                        id: item.id,
                        text: item.text,
                        category: item.category,
                        attachments: item.attachments ? item.attachments.map(att => ({
                            name: att.name,
                            size: att.size,
                            validating: att.validating || false,
                            validated: att.validated,
                            validationError: att.validationError
                            // Note: File object is not stored, only metadata
                        })) : []
                    })) : []
                }));
                localStorage.setItem(storageKey, JSON.stringify(serializableData));
            } catch (error) {
                console.error('Error saving requirements to localStorage:', error);
            }
        }

        // Load requirements from localStorage
        function loadRequirementsFromStorage() {
            try {
                const storageKey = getRequirementsStorageKey();
                const savedData = localStorage.getItem(storageKey);
                if (savedData) {
                    requirementsData = JSON.parse(savedData);
                    renderRequirementsItems();
                    if (requirementsDisplay && requirementsData.length > 0) {
                        requirementsDisplay.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading requirements from localStorage:', error);
            }
        }

        // Clear requirements from localStorage
        function clearRequirementsStorage() {
            try {
                const storageKey = getRequirementsStorageKey();
                localStorage.removeItem(storageKey);
            } catch (error) {
                console.error('Error clearing requirements from localStorage:', error);
            }
        }

        analyzeRequirementsBtn?.addEventListener('click', async () => {
            const bidId = getActiveBidId();
            if (!bidId) {
                alert('Please select a bid/project first to analyze its RFP.');
                return;
            }

            // Clear existing requirements when starting new analysis
            clearRequirementsStorage();
            requirementsData = [];

            if (analyzeRequirementsBtn) {
                analyzeRequirementsBtn.disabled = true;
            }
            if (requirementsAnalyzing) {
                requirementsAnalyzing.classList.remove('hidden');
            }
            if (requirementsDisplay) {
                requirementsDisplay.classList.add('hidden');
            }

            try {
                const response = await fetch('/api/analyze-requirements-attachments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bid_id: bidId,
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to analyze requirements and attachments.');
                }

                const outputText = (data.output || data.requirements || '').trim();

                // Parse requirements into individual items
                requirementsData = parseRequirements(outputText);

                // Save to localStorage
                saveRequirementsToStorage();

                // Render individual requirement items
                renderRequirementsItems();

                if (requirementsDisplay) {
                    requirementsDisplay.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error analyzing requirements:', error);
                alert(`Unable to analyze RFP requirements: ${error.message || error}`);
            } finally {
                if (requirementsAnalyzing) {
                    requirementsAnalyzing.classList.add('hidden');
                }
                if (analyzeRequirementsBtn) {
                    analyzeRequirementsBtn.disabled = false;
                }
            }
        });

        // Parse requirements text into individual items
        function parseRequirements(text) {
            if (!text) return [];

            const items = [];
            const lines = text.split('\n');
            let currentCategory = '';
            let currentItems = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Skip ending messages
                if (line.includes('These are the mandatory attachments') ||
                    line.includes('explicitly required for bid submission') ||
                    line.includes('No specific attachments or mandatory bid documents')) {
                    continue;
                }

                // Check if it's a category heading (starts with emoji or **)
                if (line.match(/^[📎📋✅🎯📝💼🔒💡🗓️📑]/) || line.match(/^\*\*[^*]+\*\*/)) {
                    // Save previous category items
                    if (currentCategory && currentItems.length > 0) {
                        items.push({
                            category: currentCategory,
                            items: [...currentItems]
                        });
                        currentItems = [];
                    }
                    // Extract category name (remove emoji and markdown)
                    currentCategory = line
                        .replace(/^[📎📋✅🎯📝💼🔒💡🗓️📑]\s*/, '')
                        .replace(/\*\*/g, '')
                        .trim();
                    // Default to "Mandatory Attachments & Documents" if it's the main heading
                    if (line.includes('Mandatory Attachments') || line.includes('Mandatory')) {
                        currentCategory = 'Mandatory Attachments & Documents';
                    }
                }
                // Check if it's a bullet point or list item
                else if (line.match(/^[-•*]\s+/) || line.match(/^\d+[.)]\s+/)) {
                    const itemText = line
                        .replace(/^[-•*]\s+/, '')
                        .replace(/^\d+[.)]\s+/, '')
                        .trim();
                    if (itemText) {
                        currentItems.push({
                            id: `req-${items.length}-${currentItems.length}`,
                            text: itemText,
                            category: currentCategory || 'Mandatory Attachments & Documents',
                            attachments: []
                        });
                    }
                }
                // Check if it's a regular text line (might be continuation or standalone requirement)
                else if (line.length > 20 && !line.match(/^[|]/)) {
                    // Treat as standalone requirement if it looks like one
                    if (line.match(/[A-Z][a-z]+/) || line.match(/certificate|license|form|document|attachment/i)) {
                        currentItems.push({
                            id: `req-${items.length}-${currentItems.length}`,
                            text: line,
                            category: currentCategory || 'Mandatory Attachments & Documents',
                            attachments: []
                        });
                    }
                }
            }

            // Save last category
            if (currentCategory && currentItems.length > 0) {
                items.push({
                    category: currentCategory,
                    items: [...currentItems]
                });
            }

            // If no categories found, treat each bullet as individual item
            if (items.length === 0) {
                const allItems = [];
                lines.forEach((line, idx) => {
                    const trimmed = line.trim();
                    if (trimmed && (trimmed.match(/^[-•*]\s+/) || trimmed.match(/^\d+[.)]\s+/) || trimmed.length > 20)) {
                        const itemText = trimmed
                            .replace(/^[-•*]\s+/, '')
                            .replace(/^\d+[.)]\s+/, '')
                            .trim();
                        if (itemText && itemText.length > 10) {
                            allItems.push({
                                id: `req-standalone-${idx}`,
                                text: itemText,
                                category: 'Mandatory Attachments & Documents',
                                attachments: []
                            });
                        }
                    }
                });
                if (allItems.length > 0) {
                    items.push({
                        category: 'Mandatory Attachments & Documents',
                        items: allItems
                    });
                }
            }

            return items;
        }

        // Render individual requirement items with attach buttons
        function renderRequirementsItems() {
            if (!requirementsItemsList) return;

            if (requirementsData.length === 0) {
                requirementsItemsList.innerHTML = '<p class="text-gray-500 italic text-sm">No requirements found in the RFP.</p>';
                return;
            }

            let html = '';
            requirementsData.forEach((categoryData) => {
                if (categoryData.items && categoryData.items.length > 0) {
                    // Category header
                    html += `
                        <div class="mb-4">
                            <h6 class="text-xs font-semibold uppercase tracking-wide text-gray-600 mb-2 flex items-center gap-2">
                                <i class="fas fa-paperclip text-gray-400"></i>
                                ${escapeHtml(categoryData.category)}
                            </h6>
                    `;

                    // Individual items
                    categoryData.items.forEach((item) => {
                        const attachments = item.attachments || [];
                        html += `
                            <div class="mb-3 rounded-lg border border-gray-200 bg-white p-3 shadow-sm">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm text-gray-700 leading-relaxed">${escapeHtml(item.text)}</p>
                                        ${attachments.length > 0 ? `
                                            <div class="mt-2 space-y-1">
                                                ${attachments.map((att, idx) => {
                            const sizeKB = (att.size / 1024).toFixed(1);
                            const isValid = att.validated === true;
                            const isValidating = att.validating === true;
                            const isInvalid = att.validated === false;
                            let statusClass = 'bg-gray-50';
                            let statusIcon = '<i class="fas fa-file text-gray-400"></i>';
                            let statusText = '';

                            if (isValidating) {
                                statusClass = 'bg-yellow-50 border border-yellow-200';
                                statusIcon = '<div class="h-3 w-3 border-2 border-yellow-400 border-t-yellow-600 rounded-full animate-spin"></div>';
                                statusText = '<span class="text-yellow-600 text-xs">Validating...</span>';
                            } else if (isValid) {
                                statusClass = 'bg-green-50 border border-green-200';
                                statusIcon = '<i class="fas fa-check-circle text-green-600"></i>';
                                statusText = '<span class="text-green-600 text-xs">Valid</span>';
                            } else if (isInvalid) {
                                statusClass = 'bg-red-50 border border-red-200';
                                statusIcon = '<i class="fas fa-times-circle text-red-600"></i>';
                                const errorMsg = att.validationError || 'Document does not match requirement';
                                statusText = `<span class="text-red-600 text-xs" title="${escapeHtml(errorMsg)}">Invalid: ${escapeHtml(errorMsg.length > 40 ? errorMsg.substring(0, 40) + '...' : errorMsg)}</span>`;
                            }

                            return `
                                                        <div class="flex items-center gap-2 text-xs text-gray-600 ${statusClass} px-2 py-1.5 rounded">
                                                            ${statusIcon}
                                                            <span class="truncate flex-1">${escapeHtml(att.name)}</span>
                                                            <span class="text-gray-400">(${sizeKB} KB)</span>
                                                            ${statusText}
                                                            <button onclick="removeRequirementAttachment('${item.id}', ${idx})" 
                                                                class="text-red-500 hover:text-red-700 ml-2" 
                                                                title="Remove">
                                                                <i class="fas fa-times text-xs"></i>
                                                            </button>
                                                        </div>
                                                    `;
                        }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex-shrink-0 flex items-center gap-2">
                                        <input type="file" 
                                            id="file-input-${item.id}" 
                                            class="hidden" 
                                            multiple 
                                            accept=".pdf,.jpg,.jpeg"
                                            onchange="handleRequirementAttachment('${item.id}', this, '${escapeHtml(item.text)}')">
                                        <button onclick="document.getElementById('file-input-${item.id}').click()"
                                            class="btn-secondary inline-flex items-center gap-2 rounded-lg px-3 py-1.5 text-xs font-semibold text-white transition-all">
                                            <i class="fas fa-paperclip"></i>
                                            ${attachments.length > 0 ? 'Add More' : 'Attach'}
                                        </button>
                                        <button onclick="deleteRequirementItem('${item.id}')"
                                            class="inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-semibold text-red-600 hover:text-red-700 hover:bg-red-50 border border-red-200 hover:border-red-300 transition-all"
                                            title="Delete this requirement">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>Delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div>`;
                }
            });

            requirementsItemsList.innerHTML = html || '<p class="text-gray-500 italic text-sm">No requirements found.</p>';
        }

        // Handle attachment upload for a specific requirement
        window.handleRequirementAttachment = async function (requirementId, fileInput, requirementText) {
            const files = Array.from(fileInput.files || []);
            if (files.length === 0) return;

            // Find the requirement item
            let item = null;
            requirementsData.forEach((categoryData) => {
                if (categoryData.items) {
                    const found = categoryData.items.find(i => i.id === requirementId);
                    if (found) item = found;
                }
            });

            if (!item) return;

            // Validate and add files
            for (const file of files) {
                // Validate file type
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (!['pdf', 'jpg', 'jpeg'].includes(fileExtension)) {
                    alert(`File "${file.name}" is not a valid format. Only PDF and JPG files are allowed.`);
                    continue;
                }

                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File "${file.name}" is too large. Maximum file size is 10MB.`);
                    continue;
                }

                if (!item.attachments) {
                    item.attachments = [];
                }

                // Add file with validating status
                const attachmentIndex = item.attachments.length;
                item.attachments.push({
                    name: file.name,
                    size: file.size,
                    file: file,
                    validating: true,
                    validated: null,
                    validationError: null
                });

                // Re-render to show validating state
                renderRequirementsItems();
                saveRequirementsToStorage();

                // Validate document content
                try {
                    const validationResult = await validateDocumentContent(file, requirementText);
                    item.attachments[attachmentIndex].validating = false;
                    item.attachments[attachmentIndex].validated = validationResult.is_valid;
                    if (!validationResult.is_valid) {
                        // Extract error message from validation result
                        const errorMsg = validationResult.validation_message || validationResult.message || 'Document does not match the required form type.';
                        // Remove "NO: " prefix if present
                        item.attachments[attachmentIndex].validationError = errorMsg.replace(/^NO:\s*/i, '').trim();
                    } else {
                        item.attachments[attachmentIndex].validationError = null;
                    }
                } catch (error) {
                    console.error('Validation error:', error);
                    item.attachments[attachmentIndex].validating = false;
                    item.attachments[attachmentIndex].validated = false;
                    item.attachments[attachmentIndex].validationError = error.message || 'Validation failed.';
                }

                // Re-render to show validation result
                renderRequirementsItems();
                saveRequirementsToStorage();
            }

            // Reset file input
            fileInput.value = '';
        };

        // Validate document content against requirement
        async function validateDocumentContent(file, requirementText) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('requirement_text', requirementText);

            try {
                const response = await fetch('/api/validate-requirement-attachment', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Validation failed');
                }

                return {
                    is_valid: data.is_valid === true,
                    validation_message: data.validation_message || '',
                    message: data.message || ''
                };
            } catch (error) {
                console.error('Validation API error:', error);
                throw error;
            }
        }

        // Remove attachment from a requirement
        window.removeRequirementAttachment = function (requirementId, attachmentIndex) {
            requirementsData.forEach((categoryData) => {
                if (categoryData.items) {
                    const item = categoryData.items.find(i => i.id === requirementId);
                    if (item && item.attachments) {
                        item.attachments.splice(attachmentIndex, 1);
                    }
                }
            });

            // Re-render and save
            renderRequirementsItems();
            saveRequirementsToStorage();
        };

        // Delete a requirement item completely
        window.deleteRequirementItem = function (requirementId) {
            if (!confirm('Are you sure you want to delete this requirement? This action cannot be undone.')) {
                return;
            }

            // Find and remove the item from requirementsData
            requirementsData.forEach((categoryData) => {
                if (categoryData.items) {
                    const itemIndex = categoryData.items.findIndex(i => i.id === requirementId);
                    if (itemIndex !== -1) {
                        categoryData.items.splice(itemIndex, 1);
                    }
                }
            });

            // Remove empty categories
            requirementsData = requirementsData.filter(categoryData => 
                categoryData.items && categoryData.items.length > 0
            );

            // Re-render and save
            renderRequirementsItems();
            saveRequirementsToStorage();
        };

        // ========== PDF.js Viewer and Editor ==========
        let pdfDoc = null;
        let pdfPageNum = 1;
        let pdfNumPages = 0;
        let pdfScale = 1.0;
        let pdfLibDoc = null;
        let pdfTextAnnotations = [];

        // Set up PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        const pdfCanvas = document.getElementById('pdfCanvas');
        const pdfViewerContainer = document.getElementById('pdfViewerContainer');
        const pdfLoadingIndicator = document.getElementById('pdfLoadingIndicator');
        const pdfErrorIndicator = document.getElementById('pdfErrorIndicator');
        const pdfEditorControls = document.getElementById('pdfEditorControls');
        const pdfPageInfo = document.getElementById('pdfPageInfo');
        const pdfPageInput = document.getElementById('pdfPageInput');
        const pdfZoomLevel = document.getElementById('pdfZoomLevel');
        const pdfPrevPage = document.getElementById('pdfPrevPage');
        const pdfNextPage = document.getElementById('pdfNextPage');
        const pdfGoToPage = document.getElementById('pdfGoToPage');
        const pdfZoomIn = document.getElementById('pdfZoomIn');
        const pdfZoomOut = document.getElementById('pdfZoomOut');
        const pdfAddText = document.getElementById('pdfAddText');
        const pdfExport = document.getElementById('pdfExport');

        async function loadPdfWithJs(url) {
            if (!pdfCanvas || !pdfViewerContainer) return;

            try {
                pdfLoadingIndicator.classList.remove('hidden');
                pdfErrorIndicator.classList.add('hidden');
                pdfEditorControls.classList.add('hidden');

                // Try to load PDF directly
                let loadingTask = pdfjsLib.getDocument(url);
                
                try {
                    pdfDoc = await loadingTask.promise;
                    pdfNumPages = pdfDoc.numPages;
                    pdfPageNum = 1;
                    pdfScale = 1.0;
                    
                    // Load with PDF-lib for editing
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    pdfLibDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                    
                    pdfTextAnnotations = [];
                    renderPdfPage();
                    pdfEditorControls.classList.remove('hidden');
                    pdfLoadingIndicator.classList.add('hidden');
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    // If PDF is encrypted, try to decrypt it via backend
                    if (error.message && (error.message.includes('encrypted') || error.message.includes('password'))) {
                        pdfErrorIndicator.classList.remove('hidden');
                        pdfLoadingIndicator.classList.add('hidden');
                        
                        // Attempt to decrypt via backend
                        const decryptUrl = `/api/rfp-file/decrypt?url=${encodeURIComponent(url)}`;
                        try {
                            const decryptResponse = await fetch(decryptUrl, { method: 'POST' });
                            if (decryptResponse.ok) {
                                const blob = await decryptResponse.blob();
                                const decryptedUrl = URL.createObjectURL(blob);
                                
                                loadingTask = pdfjsLib.getDocument(decryptedUrl);
                                pdfDoc = await loadingTask.promise;
                                pdfNumPages = pdfDoc.numPages;
                                pdfPageNum = 1;
                                
                                pdfLibDoc = await PDFLib.PDFDocument.load(await blob.arrayBuffer());
                                pdfTextAnnotations = [];
                                
                                renderPdfPage();
                                pdfEditorControls.classList.remove('hidden');
                                pdfErrorIndicator.classList.add('hidden');
                                pdfLoadingIndicator.classList.add('hidden');
                            } else {
                                throw new Error('Failed to decrypt PDF');
                            }
                        } catch (decryptError) {
                            console.error('Decryption failed:', decryptError);
                            pdfErrorIndicator.querySelector('p').textContent = 'PDF is encrypted and cannot be decrypted automatically.';
                        }
                    } else {
                        throw error;
                    }
                }
            } catch (error) {
                console.error('Failed to load PDF:', error);
                pdfLoadingIndicator.classList.add('hidden');
                pdfErrorIndicator.classList.remove('hidden');
                pdfErrorIndicator.querySelector('p').textContent = 'Failed to load PDF. Please try again.';
            }
        }

        async function renderPdfPage() {
            if (!pdfDoc || !pdfCanvas) return;

            try {
                const page = await pdfDoc.getPage(pdfPageNum);
                const viewport = page.getViewport({ scale: pdfScale });
                
                pdfCanvas.height = viewport.height;
                pdfCanvas.width = viewport.width;

                const renderContext = {
                    canvasContext: pdfCanvas.getContext('2d'),
                    viewport: viewport
                };

                await page.render(renderContext).promise;
                
                // Update UI
                if (pdfPageInfo) {
                    pdfPageInfo.textContent = `Page ${pdfPageNum} of ${pdfNumPages}`;
                }
                if (pdfPageInput) {
                    pdfPageInput.value = pdfPageNum;
                    pdfPageInput.max = pdfNumPages;
                }
                if (pdfZoomLevel) {
                    pdfZoomLevel.textContent = `${Math.round(pdfScale * 100)}%`;
                }
            } catch (error) {
                console.error('Error rendering PDF page:', error);
            }
        }

        // Event listeners for PDF controls
        pdfPrevPage?.addEventListener('click', () => {
            if (pdfPageNum <= 1) return;
            pdfPageNum--;
            renderPdfPage();
        });

        pdfNextPage?.addEventListener('click', () => {
            if (pdfPageNum >= pdfNumPages) return;
            pdfPageNum++;
            renderPdfPage();
        });

        pdfGoToPage?.addEventListener('click', () => {
            const pageNum = parseInt(pdfPageInput.value);
            if (pageNum >= 1 && pageNum <= pdfNumPages) {
                pdfPageNum = pageNum;
                renderPdfPage();
            }
        });

        pdfPageInput?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                pdfGoToPage.click();
            }
        });

        pdfZoomIn?.addEventListener('click', () => {
            pdfScale += 0.25;
            renderPdfPage();
        });

        pdfZoomOut?.addEventListener('click', () => {
            if (pdfScale > 0.25) {
                pdfScale -= 0.25;
                renderPdfPage();
            }
        });

        let isAddingText = false;
        pdfAddText?.addEventListener('click', () => {
            if (isAddingText) {
                // Cancel text mode
                isAddingText = false;
                pdfAddText.classList.remove('ring-2', 'ring-emerald-500');
                pdfCanvas.style.cursor = 'default';
                alert('Text mode cancelled. Click "Add Text" again to enable.');
                return;
            }
            
            const text = prompt('Enter text to add (then click on PDF to place it):');
            if (text && pdfLibDoc) {
                isAddingText = true;
                pdfAddText.classList.add('ring-2', 'ring-emerald-500');
                pdfCanvas.style.cursor = 'crosshair';
                pdfCanvas.dataset.textToAdd = text;
                alert('Click on the PDF where you want to place the text.');
            }
        });

        // Handle click on canvas to place text
        pdfCanvas?.addEventListener('click', async (e) => {
            if (!isAddingText || !pdfLibDoc) return;
            
            const text = pdfCanvas.dataset.textToAdd;
            if (!text) return;
            
            // Get click position relative to canvas
            const rect = pdfCanvas.getBoundingClientRect();
            const canvasX = e.clientX - rect.left;
            const canvasY = e.clientY - rect.top;
            
            // Convert canvas coordinates to PDF coordinates
            const page = await pdfDoc.getPage(pdfPageNum);
            const viewport = page.getViewport({ scale: pdfScale });
            
            // PDF-lib uses bottom-left origin, canvas uses top-left
            // Convert from canvas (top-left) to PDF (bottom-left) coordinates
            const pdfX = canvasX / pdfScale;
            const pdfY = (viewport.height / pdfScale) - (canvasY / pdfScale);
            
            await addTextToPdf(text, pdfX, pdfY);
            
            // Reset text mode
            isAddingText = false;
            pdfAddText.classList.remove('ring-2', 'ring-emerald-500');
            pdfCanvas.style.cursor = 'default';
            delete pdfCanvas.dataset.textToAdd;
        });

        async function addTextToPdf(text, x, y) {
            if (!pdfLibDoc) return;

            try {
                const pages = pdfLibDoc.getPages();
                const page = pages[pdfPageNum - 1];
                const { width, height } = page.getSize();
                
                // Use provided coordinates or default to center
                const textX = x !== undefined ? x : width / 2;
                const textY = y !== undefined ? y : height / 2;
                
                page.drawText(text, {
                    x: textX,
                    y: textY,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0),
                });

                // Store annotation
                pdfTextAnnotations.push({
                    page: pdfPageNum - 1,
                    text: text,
                    x: textX,
                    y: textY
                });

                // Re-render the PDF.js view
                renderPdfPage();
                
                alert('Text added! Click Export PDF to save your changes.');
            } catch (error) {
                console.error('Error adding text:', error);
                alert('Failed to add text. Please try again.');
            }
        }

        pdfExport?.addEventListener('click', async () => {
            if (!pdfLibDoc) {
                alert('No PDF loaded to export.');
                return;
            }

            try {
                const pdfBytes = await pdfLibDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                // Get the current bid ID for saving
                const rfpSectionEl = document.querySelector('[data-section="requirements"]');
                const gId = rfpSectionEl?.dataset.bidId;
                
                if (gId) {
                    // Save to server
                    const formData = new FormData();
                    formData.append('file', blob, 'edited_rfp.pdf');
                    
                    const saveResponse = await fetch(`/api/rfp-file/${gId}/save-edited`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (saveResponse.ok) {
                        const result = await saveResponse.json();
                        alert('PDF saved successfully!');
                        // Reload the PDF
                        if (rfpSectionEl.dataset.viewUrl) {
                            delete rfpSectionEl.dataset.pdfLoaded;
                            loadPdfWithJs(`${rfpSectionEl.dataset.viewUrl}?t=${Date.now()}`);
                        }
                    } else {
                        throw new Error('Failed to save PDF');
                    }
                } else {
                    // Download directly
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'edited_rfp.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('PDF exported successfully!');
                }
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Failed to export PDF. Please try again.');
            }
        });
    </script>

    <!-- Compact header at bottom -->
    <!-- <footer class="bg-white border-t border-gray-200 px-3 py-2">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 text-xs">
            <div class="flex flex-wrap items-center gap-1.5">
                <p class="text-[10px] uppercase tracking-wide text-emerald-600 font-semibold">Proposal workspace</p>
                <span class="text-gray-400">·</span>
                <h2 class="text-xs font-semibold text-gray-700">Cover Page and Offer or Information</h2>
                {% if bid_context %}
                <span class="text-gray-400">·</span>
                <div
                    class="inline-flex items-center gap-1 rounded-full border border-emerald-200 bg-emerald-50 px-1.5 py-0.5 text-[10px] text-emerald-700">
                    <i class="fas fa-diagram-project text-[9px]"></i>
                    <span>{{ bid_context.project_name }}</span>
                    {% if bid_context.bid_id %}
                    <span class="text-[9px] text-emerald-500 font-medium">ID {{ bid_context.bid_id }}</span>
                    {% endif %}
                </div>
                {% elif bid_id and bid_name %}
                <span class="text-gray-400">·</span>
                <div
                    class="inline-flex items-center gap-1 rounded-full border border-emerald-200 bg-emerald-50 px-1.5 py-0.5 text-[10px] text-emerald-700">
                    <i class="fas fa-info-circle text-[9px]"></i>
                    <span>{{ bid_name }}{% if bid_id %} · ID {{ bid_id }}{% endif %}</span>
                </div>
                {% endif %}
                {% if bid_context and bid_context.info_chips %}
                {% for chip in bid_context.info_chips %}
                <span class="text-gray-400">·</span>
                <div
                    class="inline-flex items-center gap-1 rounded-full border border-gray-200 bg-gray-50 px-1.5 py-0.5 text-[10px] text-gray-600">
                    <i class="fas fa-{{ chip.icon | default('circle-info') }} text-[9px] text-gray-400"></i>
                    <span class="font-medium text-gray-700">{{ chip.label }}:</span>
                    <span>{{ chip.value }}</span>
                </div>
                {% endfor %}
                {% endif %}
                {% if bid_context and bid_context.summary_excerpt %}
                <span class="text-gray-400">·</span>
                <p class="text-[10px] text-gray-500 max-w-md truncate">{{ bid_context.summary_excerpt }}</p>
                {% endif %}
                {% if contact_email %}
                <span class="text-gray-400">·</span>
                <p class="text-[10px] text-gray-400">Contact: {{ contact_email }}</p>
                {% endif %}
            </div>
            <div class="flex items-center gap-2">
                <div class="flex items-center gap-1 text-[10px] text-gray-500">
                    <i class="fas fa-file-pdf text-gray-400 text-[9px]"></i>
                    <span id="selectedRfpLabelBottom">
                        {% if bid_context and bid_context.rfp_label %}
                        {{ bid_context.rfp_label }}
                        {% else %}
                        No RFP attached
                        {% endif %}
                    </span>
                </div>
                <button id="generateProposalBtnBottom"
                    class="btn-primary inline-flex items-center gap-1 rounded px-2 py-1 text-[10px] text-white font-medium transition-all">
                    <i class="fas fa-wand-magic-sparkles text-[9px]"></i>
                    <span>Generate</span>
                </button>
            </div>
        </div>
    </footer> -->

</body>

</html>